'use babel';
import { Range } from 'atom';
import GutterItem from './GutterItem';
import { colorScale } from './ColourScale';
import * as GitData from '../data/GitData';
import * as IntegrationData from '../data/IntegrationData';
import CodeSelector from '../stepsize/CodeSelector';
import childProcess from 'child_process';
import * as ConfigManager from '../ConfigManager';
class GutterView {
    constructor(editor, outgoing) {
        this.previousResize = 0;
        this.markers = {};
        this.highlightDecorations = [];
        this.editor = editor;
        this.outgoing = outgoing;
        this.gutter = this.editor.addGutter({ name: 'layer' });
        this.setGutterWidth(ConfigManager.get('defaultWidth'));
        this.boundResizeListener = this.resizeListener.bind(this);
        this.fetchGutterData()
            .then(() => {
            this.drawGutter();
        })
            .catch(e => {
            throw e;
        });
        this.codeSelector = new CodeSelector(this.editor);
        return this.gutter;
    }
    buildMarkersForRanges() {
        for (const identifier in this.ranges) {
            const ranges = this.ranges[identifier];
            this.markers[identifier] = ranges.map(range => this.editor.markBufferRange(range.toAtomRange()));
        }
    }
    drawGutter() {
        this.buildMarkersForRanges();
        for (const identifier in this.markers) {
            const commit = this.commits[identifier];
            const date = commit.commitedAt;
            const commitDay = Math.floor((date - this.firstCommitDate.getTime()) / 1000 / 3600 / 24);
            colorScale(this.editor).then(scale => {
                this.markers[identifier].map(marker => {
                    const item = new GutterItem(commit);
                    this.handleResizes(item);
                    item.setIndicator('#3b3b3b'); // Set default indicator colour to display if calculations take a while
                    if (scale[commitDay]) {
                        const color = scale[Math.floor(commitDay)]
                            .rgb()
                            .fade(0.2)
                            .string();
                        item.setIndicator(color);
                    }
                    this.editor.decorateMarker(marker, {
                        type: 'gutter',
                        class: `layer-gutter`,
                        gutterName: 'layer',
                        item: item.element(),
                    });
                    item.emitter.on('mouseEnter', () => {
                        this.highlightCommit(identifier);
                    });
                    item.emitter.on('mouseLeave', () => {
                        this.removeHighlight();
                    });
                    this.handleLayerSearch(item, marker);
                });
            });
        }
    }
    handleResizes(item) {
        item.resizeEmitter.on('resizeHandleDragged', this.boundResizeListener);
        item.resizeEmitter.on('resizeHandleReleased', () => {
            this.previousResize = 0;
        });
    }
    handleLayerSearch(item, marker) {
        const codeFold = this.codeSelector.getFoldForRange(marker.getBufferRange());
        if (codeFold) {
            item.emitter.on('clickedSearch', () => {
                const range = new Range([codeFold.start, 0], [codeFold.end + 1, 0]);
                const event = this.outgoing.buildEvent(this.editor, [range], 'selection', true);
                this.outgoing.send(event, () => {
                    childProcess.exec('open -a Layer');
                });
            });
            item.emitter.on('mouseEnterLayerSearch', () => {
                this.removeHighlight();
                this.highlightMarker(codeFold.marker);
            });
            item.emitter.on('mouseLeaveLayerSearch', () => {
                this.removeHighlight();
            });
        }
    }
    highlightCommit(commitHash) {
        this.highlightDecorations.map(decoration => decoration.destroy());
        this.markers[commitHash].map(marker => {
            this.highlightDecorations.push(this.editor.decorateMarker(marker, {
                type: 'line',
                class: 'line-highlight layer-highlight',
            }));
        });
    }
    highlightMarker(marker) {
        this.highlightDecorations.map(decoration => decoration.destroy());
        this.highlightDecorations.push(this.editor.decorateMarker(marker, {
            type: 'line',
            class: 'line-highlight layer-highlight',
        }));
    }
    removeHighlight() {
        this.highlightDecorations.map(decoration => decoration.destroy());
    }
    resizeListener(resizeOffset) {
        this.setGutterWidth(this.width + (resizeOffset - this.previousResize));
        this.previousResize = resizeOffset;
    }
    static gutterStyle() {
        const sheet = document.createElement('style');
        sheet.type = 'text/css';
        sheet.id = 'layer-gutter-style';
        return sheet;
    }
    setGutterWidth(width) {
        this.width = Math.max(50, Math.min(width, 500));
        let sheet = document.getElementById('layer-gutter-style');
        if (!sheet) {
            sheet = GutterView.gutterStyle();
            document.head.appendChild(sheet);
        }
        sheet.innerHTML = `
      atom-text-editor .gutter[gutter-name="layer"] {
        width: ${this.width}px
      }
    `;
    }
    async fetchGutterData() {
        const filePath = this.editor.getPath();
        IntegrationData.getIntegrationDataForFile(filePath);
        let commits = await GitData.getCommitsForFile(filePath);
        this.commits = commits.commits;
        let ranges = await GitData.getGutterRangesForFile(filePath);
        this.ranges = ranges.ranges;
        let date = await GitData.getFirstCommitDateForRepo(filePath);
        this.firstCommitDate = new Date(date);
    }
}
export default GutterView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3V0dGVyVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9pbnRlcmZhY2UvR3V0dGVyVmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7QUFNWixPQUFPLEVBQXVCLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVsRCxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxlQUFlLE1BQU0seUJBQXlCLENBQUM7QUFDM0QsT0FBTyxZQUFZLE1BQU0sMEJBQTBCLENBQUM7QUFFcEQsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sS0FBSyxhQUFhLE1BQU0sa0JBQWtCLENBQUM7QUFFbEQ7SUFjRSxZQUFZLE1BQWUsRUFBRSxRQUEwQjtRQVAvQyxtQkFBYyxHQUFXLENBQUMsQ0FBQztRQUUzQixZQUFPLEdBQW9ELEVBQUUsQ0FBQztRQUM5RCx5QkFBb0IsR0FBc0IsRUFBRSxDQUFDO1FBS25ELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLGVBQWUsRUFBRTthQUNuQixJQUFJLENBQUM7WUFDSixJQUFJLENB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RCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDL0IsSUFBSSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQzVCLElBQUksSUFBSSxHQUFHLE1BQU0sT0FBTyxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztDQUNGO0FBRUQsZUFBZSxVQUFVLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IElFZGl0b3IgPSBBdG9tQ29yZS5JRWRpdG9yO1xuaW1wb3J0IElEaXNwbGF5QnVmZmVyTWFya2VyID0gQXRvbUNvcmUuSURpc3BsYXlCdWZmZXJNYXJrZXI7XG5pbXBvcnQgSUd1dHRlclZpZXcgPSBBdG9tQ29yZS5JR3V0dGVyVmlldztcbmltcG9ydCBEZWNvcmF0aW9uID0gQXRvbUNvcmUuRGVjb3JhdGlvbjtcbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFJhbmdlIH0gZnJvbSAnYXRvbSc7XG5pbXBvcnQgR3V0dGVyUmFuZ2UgZnJvbSAnLi9HdXR0ZXJSYW5nZSc7XG5pbXBvcnQgR3V0dGVySXRlbSBmcm9tICcuL0d1dHRlckl0ZW0nO1xuaW1wb3J0IHsgY29sb3JTY2FsZSB9IGZyb20gJy4vQ29sb3VyU2NhbGUnO1xuaW1wb3J0ICogYXMgR2l0RGF0YSBmcm9tICcuLi9kYXRhL0dpdERhdGEnO1xuaW1wb3J0ICogYXMgSW50ZWdyYXRpb25EYXRhIGZyb20gJy4uL2RhdGEvSW50ZWdyYXRpb25EYXRhJztcbmltcG9ydCBDb2RlU2VsZWN0b3IgZnJvbSAnLi4vc3RlcHNpemUvQ29kZVNlbGVjdG9yJztcbmltcG9ydCBTdGVwc2l6ZU91dGdvaW5nIGZyb20gJy4uL3N0ZXBzaXplL1N0ZXBzaXplT3V0Z29pbmcnO1xuaW1wb3J0IGNoaWxkUHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCAqIGFzIENvbmZpZ01hbmFnZXIgZnJvbSAnLi4vQ29uZmlnTWFuYWdlcic7XG5cbmNsYXNzIEd1dHRlclZpZXcge1xuICBwcml2YXRlIGVkaXRvcjogSUVkaXRvcjtcbiAgcHJpdmF0ZSBndXR0ZXI6IElHdXR0ZXJWaWV3O1xuICBwcml2YXRlIGNvbW1pdHM6IHsgW3Byb3A6IHN0cmluZ106IGFueSB9O1xuICBwcml2YXRlIHJhbmdlczogeyBbcHJvcDogc3RyaW5nXTogQXJyYXk8R3V0dGVyUmFuZ2U+IH07XG4gIHByaXZhdGUgd2lkdGg6IG51bWJlcjtcbiAgcHJpdmF0ZSBib3VuZFJlc2l6ZUxpc3RlbmVyOiBFdmVudExpc3RlbmVyO1xuICBwcml2YXRlIHByZXZpb3VzUmVzaXplOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGZpcnN0Q29tbWl0RGF0ZTogRGF0ZTtcbiAgcHJpdmF0ZSBtYXJrZXJzOiB7IFtwcm9wOiBzdHJpbmddOiBBcnJheTxJRGlzcGxheUJ1ZmZlck1hcmtlcj4gfSA9IHt9O1xuICBwcml2YXRlIGhpZ2hsaWdodERlY29yYXRpb25zOiBBcnJheTxEZWNvcmF0aW9uPiA9IFtdO1xuICBwcml2YXRlIGNvZGVTZWxlY3RvcjogQ29kZVNlbGVjdG9yO1xuICBwcml2YXRlIG91dGdvaW5nOiBTdGVwc2l6ZU91dGdvaW5nO1xuXG4gIGNvbnN0cnVjdG9yKGVkaXRvcjogSUVkaXRvciwgb3V0Z29pbmc6IFN0ZXBzaXplT3V0Z29pbmcpIHtcbiAgICB0aGlzLmVkaXRvciA9IGVkaXRvcjtcbiAgICB0aGlzLm91dGdvaW5nID0gb3V0Z29pbmc7XG4gICAgdGhpcy5ndXR0ZXIgPSB0aGlzLmVkaXRvci5hZGRHdXR0ZXIoeyBuYW1lOiAnbGF5ZXInIH0pO1xuICAgIHRoaXMuc2V0R3V0dGVyV2lkdGgoQ29uZmlnTWFuYWdlci5nZXQoJ2RlZmF1bHRXaWR0aCcpKTtcbiAgICB0aGlzLmJvdW5kUmVzaXplTGlzdGVuZXIgPSB0aGlzLnJlc2l6ZUxpc3RlbmVyLmJpbmQodGhpcyk7XG4gICAgdGhpcy5mZXRjaEd1dHRlckRhdGEoKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLmRyYXdHdXR0ZXIoKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZSA9PiB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9KTtcbiAgICB0aGlzLmNvZGVTZWxlY3RvciA9IG5ldyBDb2RlU2VsZWN0b3IodGhpcy5lZGl0b3IpO1xuICAgIHJldHVybiB0aGlzLmd1dHRlcjtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRNYXJrZXJzRm9yUmFuZ2VzKCkge1xuICAgIGZvciAoY29uc3QgaWRlbnRpZmllciBpbiB0aGlzLnJhbmdlcykge1xuICAgICAgY29uc3QgcmFuZ2VzID0gdGhpcy5yYW5nZXNbaWRlbnRpZmllcl07XG4gICAgICB0aGlzLm1hcmtlcnNbaWRlbnRpZmllcl0gPSByYW5nZXMubWFwKHJhbmdlID0+XG4gICAgICAgIHRoaXMuZWRpdG9yLm1hcmtCdWZmZXJSYW5nZShyYW5nZS50b0F0b21SYW5nZSgpKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRyYXdHdXR0ZXIoKSB7XG4gICAgdGhpcy5idWlsZE1hcmtlcnNGb3JSYW5nZXMoKTtcbiAgICBmb3IgKGNvbnN0IGlkZW50aWZpZXIgaW4gdGhpcy5tYXJrZXJzKSB7XG4gICAgICBjb25zdCBjb21taXQgPSB0aGlzLmNvbW1pdHNbaWRlbnRpZmllcl07XG4gICAgICBjb25zdCBkYXRlID0gY29tbWl0LmNvbW1pdGVkQXQ7XG4gICAgICBjb25zdCBjb21taXREYXkgPSBNYXRoLmZsb29yKFxuICAgICAgICAoZGF0ZSAtIHRoaXMuZmlyc3RDb21taXREYXRlLmdldFRpbWUoKSkgLyAxMDAwIC8gMzYwMCAvIDI0XG4gICAgICApO1xuICAgICAgY29sb3JTY2FsZSh0aGlzLmVkaXRvcikudGhlbihzY2FsZSA9PiB7XG4gICAgICAgIHRoaXMubWFya2Vyc1tpZGVudGlmaWVyXS5tYXAobWFya2VyID0+IHtcbiAgICAgICAgICBjb25zdCBpdGVtID0gbmV3IEd1dHRlckl0ZW0oY29tbWl0KTtcbiAgICAgICAgICB0aGlzLmhhbmRsZVJlc2l6ZXMoaXRlbSk7XG4gICAgICAgICAgaXRlbS5zZXRJbmRpY2F0b3IoJyMzYjNiM2InKTsgLy8gU2V0IGRlZmF1bHQgaW5kaWNhdG9yIGNvbG91ciB0byBkaXNwbGF5IGlmIGNhbGN1bGF0aW9ucyB0YWtlIGEgd2hpbGVcbiAgICAgICAgICBpZiAoc2NhbGVbY29tbWl0RGF5XSkge1xuICAgICAgICAgICAgY29uc3QgY29sb3IgPSBzY2FsZVtNYXRoLmZsb29yKGNvbW1pdERheSldXG4gICAgICAgICAgICAgIC5yZ2IoKVxuICAgICAgICAgICAgICAuZmFkZSgwLjIpXG4gICAgICAgICAgICAgIC5zdHJpbmcoKTtcbiAgICAgICAgICAgIGl0ZW0uc2V0SW5kaWNhdG9yKGNvbG9yKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5lZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG4gICAgICAgICAgICB0eXBlOiAnZ3V0dGVyJyxcbiAgICAgICAgICAgIGNsYXNzOiBgbGF5ZXItZ3V0dGVyYCxcbiAgICAgICAgICAgIGd1dHRlck5hbWU6ICdsYXllcicsXG4gICAgICAgICAgICBpdGVtOiBpdGVtLmVsZW1lbnQoKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpdGVtLmVtaXR0ZXIub24oJ21vdXNlRW50ZXInLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmhpZ2hsaWdodENvbW1pdChpZGVudGlmaWVyKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpdGVtLmVtaXR0ZXIub24oJ21vdXNlTGVhdmUnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUhpZ2hsaWdodCgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuaGFuZGxlTGF5ZXJTZWFyY2goaXRlbSwgbWFya2VyKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVSZXNpemVzKGl0ZW0pIHtcbiAgICBpdGVtLnJlc2l6ZUVtaXR0ZXIub24oJ3Jlc2l6ZUhhbmRsZURyYWdnZWQnLCB0aGlzLmJvdW5kUmVzaXplTGlzdGVuZXIpO1xuICAgIGl0ZW0ucmVzaXplRW1pdHRlci5vbigncmVzaXplSGFuZGxlUmVsZWFzZWQnLCAoKSA9PiB7XG4gICAgICB0aGlzLnByZXZpb3VzUmVzaXplID0gMDtcbiAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZUxheWVyU2VhcmNoKGl0ZW0sIG1hcmtlcikge1xuICAgIGNvbnN0IGNvZGVGb2xkID0gdGhpcy5jb2RlU2VsZWN0b3IuZ2V0Rm9sZEZvclJhbmdlKG1hcmtlci5nZXRCdWZmZXJSYW5nZSgpKTtcbiAgICBpZiAoY29kZUZvbGQpIHtcbiAgICAgIGl0ZW0uZW1pdHRlci5vbignY2xpY2tlZFNlYXJjaCcsICgpID0+IHtcbiAgICAgICAgY29uc3QgcmFuZ2UgPSBuZXcgUmFuZ2UoW2NvZGVGb2xkLnN0YXJ0LCAwXSwgW2NvZGVGb2xkLmVuZCArIDEsIDBdKTtcbiAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzLm91dGdvaW5nLmJ1aWxkRXZlbnQoXG4gICAgICAgICAgdGhpcy5lZGl0b3IsXG4gICAgICAgICAgW3JhbmdlXSxcbiAgICAgICAgICAnc2VsZWN0aW9uJyxcbiAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMub3V0Z29pbmcuc2VuZChldmVudCwgKCkgPT4ge1xuICAgICAgICAgIGNoaWxkUHJvY2Vzcy5leGVjKCdvcGVuIC1hIExheWVyJyk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICBpdGVtLmVtaXR0ZXIub24oJ21vdXNlRW50ZXJMYXllclNlYXJjaCcsICgpID0+IHtcbiAgICAgICAgdGhpcy5yZW1vdmVIaWdobGlnaHQoKTtcbiAgICAgICAgdGhpcy5oaWdobGlnaHRNYXJrZXIoY29kZUZvbGQubWFya2VyKTtcbiAgICAgIH0pO1xuICAgICAgaXRlbS5lbWl0dGVyLm9uKCdtb3VzZUxlYXZlTGF5ZXJTZWFyY2gnLCAoKSA9PiB7XG4gICAgICAgIHRoaXMucmVtb3ZlSGlnaGxpZ2h0KCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBoaWdobGlnaHRDb21taXQoY29tbWl0SGFzaDogc3RyaW5nKSB7XG4gICAgdGhpcy5oaWdobGlnaHREZWNvcmF0aW9ucy5tYXAoZGVjb3JhdGlvbiA9PiBkZWNvcmF0aW9uLmRlc3Ryb3koKSk7XG4gICAgdGhpcy5tYXJrZXJzW2NvbW1pdEhhc2hdLm1hcChtYXJrZXIgPT4ge1xuICAgICAgdGhpcy5oaWdobGlnaHREZWNvcmF0aW9ucy5wdXNoKFxuICAgICAgICB0aGlzLmVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHtcbiAgICAgICAgICB0eXBlOiAnbGluZScsXG4gICAgICAgICAgY2xhc3M6ICdsaW5lLWhpZ2hsaWdodCBsYXllci1oaWdobGlnaHQnLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGhpZ2hsaWdodE1hcmtlcihtYXJrZXIpIHtcbiAgICB0aGlzLmhpZ2hsaWdodERlY29yYXRpb25zLm1hcChkZWNvcmF0aW9uID0+IGRlY29yYXRpb24uZGVzdHJveSgpKTtcbiAgICB0aGlzLmhpZ2hsaWdodERlY29yYXRpb25zLnB1c2goXG4gICAgICB0aGlzLmVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHtcbiAgICAgICAgdHlwZTogJ2xpbmUnLFxuICAgICAgICBjbGFzczogJ2xpbmUtaGlnaGxpZ2h0IGxheWVyLWhpZ2hsaWdodCcsXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICByZW1vdmVIaWdobGlnaHQoKSB7XG4gICAgdGhpcy5oaWdobGlnaHREZWNvcmF0aW9ucy5tYXAoZGVjb3JhdGlvbiA9PiBkZWNvcmF0aW9uLmRlc3Ryb3koKSk7XG4gIH1cblxuICByZXNpemVMaXN0ZW5lcihyZXNpemVPZmZzZXQ6IG51bWJlcikge1xuICAgIHRoaXMuc2V0R3V0dGVyV2lkdGgodGhpcy53aWR0aCArIChyZXNpemVPZmZzZXQgLSB0aGlzLnByZXZpb3VzUmVzaXplKSk7XG4gICAgdGhpcy5wcmV2aW91c1Jlc2l6ZSA9IHJlc2l6ZU9mZnNldDtcbiAgfVxuXG4gIHN0YXRpYyBndXR0ZXJTdHlsZSgpIHtcbiAgICBjb25zdCBzaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG4gICAgc2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7XG4gICAgc2hlZXQuaWQgPSAnbGF5ZXItZ3V0dGVyLXN0eWxlJztcbiAgICByZXR1cm4gc2hlZXQ7XG4gIH1cblxuICBzZXRHdXR0ZXJXaWR0aCh3aWR0aDogbnVtYmVyKSB7XG4gICAgdGhpcy53aWR0aCA9IE1hdGgubWF4KDUwLCBNYXRoLm1pbih3aWR0aCwgNTAwKSk7XG4gICAgbGV0IHNoZWV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xheWVyLWd1dHRlci1zdHlsZScpO1xuICAgIGlmICghc2hlZXQpIHtcbiAgICAgIHNoZWV0ID0gR3V0dGVyVmlldy5ndXR0ZXJTdHlsZSgpO1xuICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzaGVldCk7XG4gICAgfVxuICAgIHNoZWV0LmlubmVySFRNTCA9IGBcbiAgICAgIGF0b20tdGV4dC1lZGl0b3IgLmd1dHRlcltndXR0ZXItbmFtZT1cImxheWVyXCJdIHtcbiAgICAgICAgd2lkdGg6ICR7dGhpcy53aWR0aH1weFxuICAgICAgfVxuICAgIGA7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZldGNoR3V0dGVyRGF0YSgpIHtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuZWRpdG9yLmdldFBhdGgoKTtcbiAgICBJbnRlZ3JhdGlvbkRhdGEuZ2V0SW50ZWdyYXRpb25EYXRhRm9yRmlsZShmaWxlUGF0aCk7XG4gICAgbGV0IGNvbW1pdHMgPSBhd2FpdCBHaXREYXRhLmdldENvbW1pdHNGb3JGaWxlKGZpbGVQYXRoKTtcbiAgICB0aGlzLmNvbW1pdHMgPSBjb21taXRzLmNvbW1pdHM7XG4gICAgbGV0IHJhbmdlcyA9IGF3YWl0IEdpdERhdGEuZ2V0R3V0dGVyUmFuZ2VzRm9yRmlsZShmaWxlUGF0aCk7XG4gICAgdGhpcy5yYW5nZXMgPSByYW5nZXMucmFuZ2VzO1xuICAgIGxldCBkYXRlID0gYXdhaXQgR2l0RGF0YS5nZXRGaXJzdENvbW1pdERhdGVGb3JSZXBvKGZpbGVQYXRoKTtcbiAgICB0aGlzLmZpcnN0Q29tbWl0RGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEd1dHRlclZpZXc7XG4iXX0=