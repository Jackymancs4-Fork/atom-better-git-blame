'use babel';
import { Range } from 'atom';
import GutterItem from './GutterItem';
import { colorScale } from './ColourScale';
import * as GitData from '../data/GitData';
import * as IntegrationData from '../data/IntegrationData';
import CodeSelector from '../stepsize/CodeSelector';
import childProcess from 'child_process';
import * as ConfigManager from '../ConfigManager';
import * as Analytics from '../stepsize/Analytics';
class GutterView {
    constructor(editor, outgoing) {
        this.previousResize = 0;
        this.markers = {};
        this.highlightDecorations = [];
        this.editor = editor;
        this.outgoing = outgoing;
        this.gutter = this.editor.addGutter({ name: 'layer' });
        this.setGutterWidth(ConfigManager.get('defaultWidth'));
        this.boundResizeListener = this.resizeListener.bind(this);
        this.fetchGutterData()
            .then(() => {
            this.drawGutter();
        })
            .catch(e => {
            throw e;
        });
        this.codeSelector = new CodeSelector(this.editor);
        return this.gutter;
    }
    buildMarkersForRanges() {
        for (const identifier in this.ranges) {
            const ranges = this.ranges[identifier];
            this.markers[identifier] = ranges.map(range => this.editor.markBufferRange(range.toAtomRange()));
        }
    }
    drawGutter() {
        this.buildMarkersForRanges();
        for (const identifier in this.markers) {
            const commit = this.commits[identifier];
            const date = commit.commitedAt;
            const commitDay = Math.floor((date - this.firstCommitDate.getTime()) / 1000 / 3600 / 24);
            colorScale(this.editor).then(scale => {
                this.markers[identifier].map(marker => {
                    const item = new GutterItem(commit);
                    this.handleResizes(item);
                    item.setIndicator('#3b3b3b'); // Set default indicator colour to display if calculations take a while
                    if (scale[commitDay]) {
                        const color = scale[Math.floor(commitDay)]
                            .rgb()
                            .fade(0.2)
                            .string();
                        item.setIndicator(color);
                    }
                    this.editor.decorateMarker(marker, {
                        type: 'gutter',
                        class: `layer-gutter`,
                        gutterName: 'layer',
                        item: item.element(),
                    });
                    item.emitter.on('mouseEnter', () => {
                        this.highlightCommit(identifier);
                        if (ConfigManager.get('highlightPullRequestOnHover')) {
                            this.highlightPullRequestForCommit(identifier);
                        }
                    });
                    item.emitter.on('mouseLeave', () => {
                        this.removeHighlight();
                        this.removeOverlayOverflowHack();
                    });
                    this.handleLayerSearch(item, marker);
                });
            });
        }
    }
    handleResizes(item) {
        item.resizeEmitter.on('resizeHandleDragged', this.boundResizeListener);
        item.resizeEmitter.on('resizeHandleReleased', () => {
            this.previousResize = 0;
        });
    }
    handleLayerSearch(item, marker) {
        const codeFold = this.codeSelector.getFoldForRange(marker.getBufferRange());
        if (codeFold) {
            item.emitter.on('clickedSearch', () => {
                Analytics.track('Search in Layer clicked');
                const range = new Range([codeFold.start, 0], [codeFold.end + 1, 0]);
                const event = this.outgoing.buildEvent(this.editor, [range], 'selection', true);
                this.outgoing.send(event, () => {
                    childProcess.exec('open -a Layer');
                });
            });
            item.emitter.on('mouseEnterLayerSearch', () => {
                this.removeHighlight();
                this.highlightMarker(codeFold.marker);
            });
            item.emitter.on('mouseLeaveLayerSearch', () => {
                this.removeHighlight();
            });
        }
    }
    highlightCommit(commitHash, labelContent = `<span class="icon icon-git-commit"></span>${commitHash.substr(0, 6)}`, customClasses = '') {
        if (!this.markers[commitHash])
            return;
        this.markers[commitHash].map(async (marker) => {
            const decoration = this.editor.decorateMarker(marker, {
                type: 'line',
                class: `line-highlight layer-highlight ${customClasses}`,
            });
            this.highlightDecorations.push(decoration);
            if (ConfigManager.get('displayHighlightLabels')) {
                const label = document.createElement('div');
                label.style['width'] = '100%';
                label.style['height'] = '19px';
                label.style['opacity'] = '0.5';
                label.innerHTML = labelContent;
                const labelDecoration = this.editor.decorateMarker(marker, {
                    type: 'overlay',
                    class: 'label-highlight',
                    position: 'tail',
                    avoidOverflow: false,
                    item: label,
                });
                this.highlightDecorations.push(labelDecoration);
            }
        });
    }
    async highlightPullRequestForCommit(commitHash) {
        this.overlayOverflowHack();
        await this.integrationData;
        let pullRequests = await IntegrationData.getPullRequestsForCommit(this.editor.getPath(), commitHash);
        if (pullRequests.length > 0) {
            let commits = await IntegrationData.getCommitsForPullRequest(this.editor.getPath(), pullRequests[0].number);
            if (commits) {
                commits = commits.filter(hash => hash != commitHash);
                commits.map(hash => {
                    console.log(hash);
                    this.highlightCommit(hash, `<span class="icon icon-git-pull-request"></span>#${pullRequests[0]
                        .number}`, 'pr-line-highlight');
                });
            }
        }
    }
    overlayOverflowHack() {
        this.overlayHack = document.createElement('style');
        document.head.appendChild(this.overlayHack);
        this.overlayHack.innerHTML = `
      .tab-bar, .status-bar {
        z-index: 6;
      }
    `;
    }
    removeOverlayOverflowHack() {
        if (this.overlayHack) {
            this.overlayHack.remove();
        }
    }
    highlightMarker(marker) {
        this.highlightDecorations.map(decoration => decoration.destroy());
        this.highlightDecorations.push(this.editor.decorateMarker(marker, {
            type: 'line',
            class: 'line-highlight layer-highlight',
        }));
    }
    removeHighlight() {
        this.highlightDecorations.map(decoration => decoration.destroy());
    }
    resizeListener(resizeOffset) {
        this.setGutterWidth(this.width + (resizeOffset - this.previousResize));
        this.previousResize = resizeOffset;
    }
    static gutterStyle() {
        const sheet = document.createElement('style');
        sheet.type = 'text/css';
        sheet.id = 'layer-gutter-style';
        return sheet;
    }
    setGutterWidth(width) {
        this.width = Math.max(50, Math.min(width, 500));
        let sheet = document.getElementById('layer-gutter-style');
        if (!sheet) {
            sheet = GutterView.gutterStyle();
            document.head.appendChild(sheet);
        }
        sheet.innerHTML = `
      atom-text-editor .gutter[gutter-name="layer"] {
        width: ${this.width}px
      }
    `;
    }
    async fetchGutterData() {
        const filePath = this.editor.getPath();
        this.integrationData = IntegrationData.getIntegrationDataForFile(filePath);
        let commits = await GitData.getCommitsForFile(filePath);
        this.commits = commits.commits;
        let ranges = await GitData.getGutterRangesForFile(filePath);
        this.ranges = ranges.ranges;
        let date = await GitData.getFirstCommitDateForRepo(filePath);
        this.firstCommitDate = new Date(date);
    }
}
export default GutterView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3V0dGVyVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9pbnRlcmZhY2UvR3V0dGVyVmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7QUFNWixPQUFPLEVBQXVCLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVsRCxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxlQUFlLE1BQU0seUJBQXlCLENBQUM7QUFDM0QsT0FBTyxZQUFZLE1BQU0sMEJBQTBCLENBQUM7QUFFcEQsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sS0FBSyxhQUFhLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxLQUFLLFNBQVMsTUFBTSx1QkFBdUIsQ0FBQztBQUVuRDtJQWdCRSxZQUFZLE1BQWUsRUFBRSxRQUEwQjtRQVQvQyxtQkFBYyxHQUFXLENBQUMsQ0FBQztRQUUzQixZQUFPLEdBQW9ELEVBQUUsQ0FBQztRQUM5RCx5QkFBb0IsR0FBc0IsRUFBRSxDQUFDO1FBT25ELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFD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QUM7SUFFTyxLQUFLLENBQUMsZUFBZTtRQUMzQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNFLElBQUksT0FBTyxHQUFHLE1BQU0sT0FBTyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUMvQixJQUFJLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDNUIsSUFBSSxJQUFJLEdBQUcsTUFBTSxPQUFPLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxDQUFDO0NBQ0Y7QUFFRCxlQUFlLFVBQVUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgSUVkaXRvciA9IEF0b21Db3JlLklFZGl0b3I7XG5pbXBvcnQgSURpc3BsYXlCdWZmZXJNYXJrZXIgPSBBdG9tQ29yZS5JRGlzcGxheUJ1ZmZlck1hcmtlcjtcbmltcG9ydCBJR3V0dGVyVmlldyA9IEF0b21Db3JlLklHdXR0ZXJWaWV3O1xuaW1wb3J0IERlY29yYXRpb24gPSBBdG9tQ29yZS5EZWNvcmF0aW9uO1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUmFuZ2UgfSBmcm9tICdhdG9tJztcbmltcG9ydCBHdXR0ZXJSYW5nZSBmcm9tICcuL0d1dHRlclJhbmdlJztcbmltcG9ydCBHdXR0ZXJJdGVtIGZyb20gJy4vR3V0dGVySXRlbSc7XG5pbXBvcnQgeyBjb2xvclNjYWxlIH0gZnJvbSAnLi9Db2xvdXJTY2FsZSc7XG5pbXBvcnQgKiBhcyBHaXREYXRhIGZyb20gJy4uL2RhdGEvR2l0RGF0YSc7XG5pbXBvcnQgKiBhcyBJbnRlZ3JhdGlvbkRhdGEgZnJvbSAnLi4vZGF0YS9JbnRlZ3JhdGlvbkRhdGEnO1xuaW1wb3J0IENvZGVTZWxlY3RvciBmcm9tICcuLi9zdGVwc2l6ZS9Db2RlU2VsZWN0b3InO1xuaW1wb3J0IFN0ZXBzaXplT3V0Z29pbmcgZnJvbSAnLi4vc3RlcHNpemUvU3RlcHNpemVPdXRnb2luZyc7XG5pbXBvcnQgY2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgQ29uZmlnTWFuYWdlciBmcm9tICcuLi9Db25maWdNYW5hZ2VyJztcbmltcG9ydCAqIGFzIEFuYWx5dGljcyBmcm9tICcuLi9zdGVwc2l6ZS9BbmFseXRpY3MnO1xuXG5jbGFzcyBHdXR0ZXJWaWV3IHtcbiAgcHJpdmF0ZSBlZGl0b3I6IElFZGl0b3I7XG4gIHByaXZhdGUgZ3V0dGVyOiBJR3V0dGVyVmlldztcbiAgcHJpdmF0ZSBjb21taXRzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfTtcbiAgcHJpdmF0ZSByYW5nZXM6IHsgW3Byb3A6IHN0cmluZ106IEFycmF5PEd1dHRlclJhbmdlPiB9O1xuICBwcml2YXRlIHdpZHRoOiBudW1iZXI7XG4gIHByaXZhdGUgYm91bmRSZXNpemVMaXN0ZW5lcjogRXZlbnRMaXN0ZW5lcjtcbiAgcHJpdmF0ZSBwcmV2aW91c1Jlc2l6ZTogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBmaXJzdENvbW1pdERhdGU6IERhdGU7XG4gIHByaXZhdGUgbWFya2VyczogeyBbcHJvcDogc3RyaW5nXTogQXJyYXk8SURpc3BsYXlCdWZmZXJNYXJrZXI+IH0gPSB7fTtcbiAgcHJpdmF0ZSBoaWdobGlnaHREZWNvcmF0aW9uczogQXJyYXk8RGVjb3JhdGlvbj4gPSBbXTtcbiAgcHJpdmF0ZSBjb2RlU2VsZWN0b3I6IENvZGVTZWxlY3RvcjtcbiAgcHJpdmF0ZSBvdXRnb2luZzogU3RlcHNpemVPdXRnb2luZztcbiAgcHJpdmF0ZSBpbnRlZ3JhdGlvbkRhdGE6IGFueTtcbiAgcHJpdmF0ZSBvdmVybGF5SGFjazogSFRNTEVsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoZWRpdG9yOiBJRWRpdG9yLCBvdXRnb2luZzogU3RlcHNpemVPdXRnb2luZykge1xuICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yO1xuICAgIHRoaXMub3V0Z29pbmcgPSBvdXRnb2luZztcbiAgICB0aGlzLmd1dHRlciA9IHRoaXMuZWRpdG9yLmFkZEd1dHRlcih7IG5hbWU6ICdsYXllcicgfSk7XG4gICAgdGhpcy5zZXRHdXR0ZXJXaWR0aChDb25maWdNYW5hZ2VyLmdldCgnZGVmYXVsdFdpZHRoJykpO1xuICAgIHRoaXMuYm91bmRSZXNpemVMaXN0ZW5lciA9IHRoaXMucmVzaXplTGlzdGVuZXIuYmluZCh0aGlzKTtcbiAgICB0aGlzLmZldGNoR3V0dGVyRGF0YSgpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuZHJhd0d1dHRlcigpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlID0+IHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH0pO1xuICAgIHRoaXMuY29kZVNlbGVjdG9yID0gbmV3IENvZGVTZWxlY3Rvcih0aGlzLmVkaXRvcik7XG4gICAgcmV0dXJuIHRoaXMuZ3V0dGVyO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZE1hcmtlcnNGb3JSYW5nZXMoKSB7XG4gICAgZm9yIChjb25zdCBpZGVudGlmaWVyIGluIHRoaXMucmFuZ2VzKSB7XG4gICAgICBjb25zdCByYW5nZXMgPSB0aGlzLnJhbmdlc1tpZGVudGlmaWVyXTtcbiAgICAgIHRoaXMubWFya2Vyc1tpZGVudGlmaWVyXSA9IHJhbmdlcy5tYXAocmFuZ2UgPT5cbiAgICAgICAgdGhpcy5lZGl0b3IubWFya0J1ZmZlclJhbmdlKHJhbmdlLnRvQXRvbVJhbmdlKCkpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZHJhd0d1dHRlcigpIHtcbiAgICB0aGlzLmJ1aWxkTWFya2Vyc0ZvclJhbmdlcygpO1xuICAgIGZvciAoY29uc3QgaWRlbnRpZmllciBpbiB0aGlzLm1hcmtlcnMpIHtcbiAgICAgIGNvbnN0IGNvbW1pdCA9IHRoaXMuY29tbWl0c1tpZGVudGlmaWVyXTtcbiAgICAgIGNvbnN0IGRhdGUgPSBjb21taXQuY29tbWl0ZWRBdDtcbiAgICAgIGNvbnN0IGNvbW1pdERheSA9IE1hdGguZmxvb3IoXG4gICAgICAgIChkYXRlIC0gdGhpcy5maXJzdENvbW1pdERhdGUuZ2V0VGltZSgpKSAvIDEwMDAgLyAzNjAwIC8gMjRcbiAgICAgICk7XG4gICAgICBjb2xvclNjYWxlKHRoaXMuZWRpdG9yKS50aGVuKHNjYWxlID0+IHtcbiAgICAgICAgdGhpcy5tYXJrZXJzW2lkZW50aWZpZXJdLm1hcChtYXJrZXIgPT4ge1xuICAgICAgICAgIGNvbnN0IGl0ZW0gPSBuZXcgR3V0dGVySXRlbShjb21taXQpO1xuICAgICAgICAgIHRoaXMuaGFuZGxlUmVzaXplcyhpdGVtKTtcbiAgICAgICAgICBpdGVtLnNldEluZGljYXRvcignIzNiM2IzYicpOyAvLyBTZXQgZGVmYXVsdCBpbmRpY2F0b3IgY29sb3VyIHRvIGRpc3BsYXkgaWYgY2FsY3VsYXRpb25zIHRha2UgYSB3aGlsZVxuICAgICAgICAgIGlmIChzY2FsZVtjb21taXREYXldKSB7XG4gICAgICAgICAgICBjb25zdCBjb2xvciA9IHNjYWxlW01hdGguZmxvb3IoY29tbWl0RGF5KV1cbiAgICAgICAgICAgICAgLnJnYigpXG4gICAgICAgICAgICAgIC5mYWRlKDAuMilcbiAgICAgICAgICAgICAgLnN0cmluZygpO1xuICAgICAgICAgICAgaXRlbS5zZXRJbmRpY2F0b3IoY29sb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHtcbiAgICAgICAgICAgIHR5cGU6ICdndXR0ZXInLFxuICAgICAgICAgICAgY2xhc3M6IGBsYXllci1ndXR0ZXJgLFxuICAgICAgICAgICAgZ3V0dGVyTmFtZTogJ2xheWVyJyxcbiAgICAgICAgICAgIGl0ZW06IGl0ZW0uZWxlbWVudCgpLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGl0ZW0uZW1pdHRlci5vbignbW91c2VFbnRlcicsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0Q29tbWl0KGlkZW50aWZpZXIpO1xuICAgICAgICAgICAgaWYgKENvbmZpZ01hbmFnZXIuZ2V0KCdoaWdobGlnaHRQdWxsUmVxdWVzdE9uSG92ZXInKSkge1xuICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodFB1bGxSZXF1ZXN0Rm9yQ29tbWl0KGlkZW50aWZpZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGl0ZW0uZW1pdHRlci5vbignbW91c2VMZWF2ZScsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlSGlnaGxpZ2h0KCk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZU92ZXJsYXlPdmVyZmxvd0hhY2soKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLmhhbmRsZUxheWVyU2VhcmNoKGl0ZW0sIG1hcmtlcik7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlUmVzaXplcyhpdGVtKSB7XG4gICAgaXRlbS5yZXNpemVFbWl0dGVyLm9uKCdyZXNpemVIYW5kbGVEcmFnZ2VkJywgdGhpcy5ib3VuZFJlc2l6ZUxpc3RlbmVyKTtcbiAgICBpdGVtLnJlc2l6ZUVtaXR0ZXIub24oJ3Jlc2l6ZUhhbmRsZVJlbGVhc2VkJywgKCkgPT4ge1xuICAgICAgdGhpcy5wcmV2aW91c1Jlc2l6ZSA9IDA7XG4gICAgfSk7XG4gIH1cblxuICBoYW5kbGVMYXllclNlYXJjaChpdGVtLCBtYXJrZXIpIHtcbiAgICBjb25zdCBjb2RlRm9sZCA9IHRoaXMuY29kZVNlbGVjdG9yLmdldEZvbGRGb3JSYW5nZShtYXJrZXIuZ2V0QnVmZmVyUmFuZ2UoKSk7XG4gICAgaWYgKGNvZGVGb2xkKSB7XG4gICAgICBpdGVtLmVtaXR0ZXIub24oJ2NsaWNrZWRTZWFyY2gnLCAoKSA9PiB7XG4gICAgICAgIEFuYWx5dGljcy50cmFjaygnU2VhcmNoIGluIExheWVyIGNsaWNrZWQnKTtcbiAgICAgICAgY29uc3QgcmFuZ2UgPSBuZXcgUmFuZ2UoW2NvZGVGb2xkLnN0YXJ0LCAwXSwgW2NvZGVGb2xkLmVuZCArIDEsIDBdKTtcbiAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzLm91dGdvaW5nLmJ1aWxkRXZlbnQoXG4gICAgICAgICAgdGhpcy5lZGl0b3IsXG4gICAgICAgICAgW3JhbmdlXSxcbiAgICAgICAgICAnc2VsZWN0aW9uJyxcbiAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMub3V0Z29pbmcuc2VuZChldmVudCwgKCkgPT4ge1xuICAgICAgICAgIGNoaWxkUHJvY2Vzcy5leGVjKCdvcGVuIC1hIExheWVyJyk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICBpdGVtLmVtaXR0ZXIub24oJ21vdXNlRW50ZXJMYXllclNlYXJjaCcsICgpID0+IHtcbiAgICAgICAgdGhpcy5yZW1vdmVIaWdobGlnaHQoKTtcbiAgICAgICAgdGhpcy5oaWdobGlnaHRNYXJrZXIoY29kZUZvbGQubWFya2VyKTtcbiAgICAgIH0pO1xuICAgICAgaXRlbS5lbWl0dGVyLm9uKCdtb3VzZUxlYXZlTGF5ZXJTZWFyY2gnLCAoKSA9PiB7XG4gICAgICAgIHRoaXMucmVtb3ZlSGlnaGxpZ2h0KCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBoaWdobGlnaHRDb21taXQoXG4gICAgY29tbWl0SGFzaDogc3RyaW5nLFxuICAgIGxhYmVsQ29udGVudCA9IGA8c3BhbiBjbGFzcz1cImljb24gaWNvbi1naXQtY29tbWl0XCI+PC9zcGFuPiR7Y29tbWl0SGFzaC5zdWJzdHIoXG4gICAgICAwLFxuICAgICAgNlxuICAgICl9YCxcbiAgICBjdXN0b21DbGFzc2VzID0gJydcbiAgKSB7XG4gICAgaWYgKCF0aGlzLm1hcmtlcnNbY29tbWl0SGFzaF0pIHJldHVybjtcbiAgICB0aGlzLm1hcmtlcnNbY29tbWl0SGFzaF0ubWFwKGFzeW5jIG1hcmtlciA9PiB7XG4gICAgICBjb25zdCBkZWNvcmF0aW9uID0gdGhpcy5lZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG4gICAgICAgIHR5cGU6ICdsaW5lJyxcbiAgICAgICAgY2xhc3M6IGBsaW5lLWhpZ2hsaWdodCBsYXllci1oaWdobGlnaHQgJHtjdXN0b21DbGFzc2VzfWAsXG4gICAgICB9KTtcbiAgICAgIHRoaXMuaGlnaGxpZ2h0RGVjb3JhdGlvbnMucHVzaChkZWNvcmF0aW9uKTtcbiAgICAgIGlmIChDb25maWdNYW5hZ2VyLmdldCgnZGlzcGxheUhpZ2hsaWdodExhYmVscycpKSB7XG4gICAgICAgIGNvbnN0IGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIGxhYmVsLnN0eWxlWyd3aWR0aCddID0gJzEwMCUnO1xuICAgICAgICBsYWJlbC5zdHlsZVsnaGVpZ2h0J10gPSAnMTlweCc7XG4gICAgICAgIGxhYmVsLnN0eWxlWydvcGFjaXR5J10gPSAnMC41JztcbiAgICAgICAgbGFiZWwuaW5uZXJIVE1MID0gbGFiZWxDb250ZW50O1xuICAgICAgICBjb25zdCBsYWJlbERlY29yYXRpb24gPSB0aGlzLmVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHtcbiAgICAgICAgICB0eXBlOiAnb3ZlcmxheScsXG4gICAgICAgICAgY2xhc3M6ICdsYWJlbC1oaWdobGlnaHQnLFxuICAgICAgICAgIHBvc2l0aW9uOiAndGFpbCcsXG4gICAgICAgICAgYXZvaWRPdmVyZmxvdzogZmFsc2UsXG4gICAgICAgICAgaXRlbTogbGFiZWwsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmhpZ2hsaWdodERlY29yYXRpb25zLnB1c2gobGFiZWxEZWNvcmF0aW9uKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGhpZ2hsaWdodFB1bGxSZXF1ZXN0Rm9yQ29tbWl0KGNvbW1pdEhhc2gpIHtcbiAgICB0aGlzLm92ZXJsYXlPdmVyZmxvd0hhY2soKTtcbiAgICBhd2FpdCB0aGlzLmludGVncmF0aW9uRGF0YTtcbiAgICBsZXQgcHVsbFJlcXVlc3RzID0gYXdhaXQgSW50ZWdyYXRpb25EYXRhLmdldFB1bGxSZXF1ZXN0c0ZvckNvbW1pdChcbiAgICAgIHRoaXMuZWRpdG9yLmdldFBhdGgoKSxcbiAgICAgIGNvbW1pdEhhc2hcbiAgICApO1xuICAgIGlmIChwdWxsUmVxdWVzdHMubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IGNvbW1pdHMgPSBhd2FpdCBJbnRlZ3JhdGlvbkRhdGEuZ2V0Q29tbWl0c0ZvclB1bGxSZXF1ZXN0KFxuICAgICAgICB0aGlzLmVkaXRvci5nZXRQYXRoKCksXG4gICAgICAgIHB1bGxSZXF1ZXN0c1swXS5udW1iZXJcbiAgICAgICk7XG4gICAgICBpZiAoY29tbWl0cykge1xuICAgICAgICBjb21taXRzID0gY29tbWl0cy5maWx0ZXIoaGFzaCA9PiBoYXNoICE9IGNvbW1pdEhhc2gpO1xuICAgICAgICBjb21taXRzLm1hcChoYXNoID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhoYXNoKTtcbiAgICAgICAgICB0aGlzLmhpZ2hsaWdodENvbW1pdChcbiAgICAgICAgICAgIGhhc2gsXG4gICAgICAgICAgICBgPHNwYW4gY2xhc3M9XCJpY29uIGljb24tZ2l0LXB1bGwtcmVxdWVzdFwiPjwvc3Bhbj4jJHtwdWxsUmVxdWVzdHNbMF1cbiAgICAgICAgICAgICAgLm51bWJlcn1gLFxuICAgICAgICAgICAgJ3ByLWxpbmUtaGlnaGxpZ2h0J1xuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG92ZXJsYXlPdmVyZmxvd0hhY2soKSB7XG4gICAgdGhpcy5vdmVybGF5SGFjayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG4gICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCh0aGlzLm92ZXJsYXlIYWNrKTtcbiAgICB0aGlzLm92ZXJsYXlIYWNrLmlubmVySFRNTCA9IGBcbiAgICAgIC50YWItYmFyLCAuc3RhdHVzLWJhciB7XG4gICAgICAgIHotaW5kZXg6IDY7XG4gICAgICB9XG4gICAgYDtcbiAgfVxuXG4gIHJlbW92ZU92ZXJsYXlPdmVyZmxvd0hhY2soKSB7XG4gICAgaWYgKHRoaXMub3ZlcmxheUhhY2spIHtcbiAgICAgIHRoaXMub3ZlcmxheUhhY2sucmVtb3ZlKCk7XG4gICAgfVxuICB9XG5cbiAgaGlnaGxpZ2h0TWFya2VyKG1hcmtlcikge1xuICAgIHRoaXMuaGlnaGxpZ2h0RGVjb3JhdGlvbnMubWFwKGRlY29yYXRpb24gPT4gZGVjb3JhdGlvbi5kZXN0cm95KCkpO1xuICAgIHRoaXMuaGlnaGxpZ2h0RGVjb3JhdGlvbnMucHVzaChcbiAgICAgIHRoaXMuZWRpdG9yLmRlY29yYXRlTWFya2VyKG1hcmtlciwge1xuICAgICAgICB0eXBlOiAnbGluZScsXG4gICAgICAgIGNsYXNzOiAnbGluZS1oaWdobGlnaHQgbGF5ZXItaGlnaGxpZ2h0JyxcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHJlbW92ZUhpZ2hsaWdodCgpIHtcbiAgICB0aGlzLmhpZ2hsaWdodERlY29yYXRpb25zLm1hcChkZWNvcmF0aW9uID0+IGRlY29yYXRpb24uZGVzdHJveSgpKTtcbiAgfVxuXG4gIHJlc2l6ZUxpc3RlbmVyKHJlc2l6ZU9mZnNldDogbnVtYmVyKSB7XG4gICAgdGhpcy5zZXRHdXR0ZXJXaWR0aCh0aGlzLndpZHRoICsgKHJlc2l6ZU9mZnNldCAtIHRoaXMucHJldmlvdXNSZXNpemUpKTtcbiAgICB0aGlzLnByZXZpb3VzUmVzaXplID0gcmVzaXplT2Zmc2V0O1xuICB9XG5cbiAgc3RhdGljIGd1dHRlclN0eWxlKCkge1xuICAgIGNvbnN0IHNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgICBzaGVldC50eXBlID0gJ3RleHQvY3NzJztcbiAgICBzaGVldC5pZCA9ICdsYXllci1ndXR0ZXItc3R5bGUnO1xuICAgIHJldHVybiBzaGVldDtcbiAgfVxuXG4gIHNldEd1dHRlcldpZHRoKHdpZHRoOiBudW1iZXIpIHtcbiAgICB0aGlzLndpZHRoID0gTWF0aC5tYXgoNTAsIE1hdGgubWluKHdpZHRoLCA1MDApKTtcbiAgICBsZXQgc2hlZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGF5ZXItZ3V0dGVyLXN0eWxlJyk7XG4gICAgaWYgKCFzaGVldCkge1xuICAgICAgc2hlZXQgPSBHdXR0ZXJWaWV3Lmd1dHRlclN0eWxlKCk7XG4gICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNoZWV0KTtcbiAgICB9XG4gICAgc2hlZXQuaW5uZXJIVE1MID0gYFxuICAgICAgYXRvbS10ZXh0LWVkaXRvciAuZ3V0dGVyW2d1dHRlci1uYW1lPVwibGF5ZXJcIl0ge1xuICAgICAgICB3aWR0aDogJHt0aGlzLndpZHRofXB4XG4gICAgICB9XG4gICAgYDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmV0Y2hHdXR0ZXJEYXRhKCkge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5lZGl0b3IuZ2V0UGF0aCgpO1xuICAgIHRoaXMuaW50ZWdyYXRpb25EYXRhID0gSW50ZWdyYXRpb25EYXRhLmdldEludGVncmF0aW9uRGF0YUZvckZpbGUoZmlsZVBhdGgpO1xuICAgIGxldCBjb21taXRzID0gYXdhaXQgR2l0RGF0YS5nZXRDb21taXRzRm9yRmlsZShmaWxlUGF0aCk7XG4gICAgdGhpcy5jb21taXRzID0gY29tbWl0cy5jb21taXRzO1xuICAgIGxldCByYW5nZXMgPSBhd2FpdCBHaXREYXRhLmdldEd1dHRlclJhbmdlc0ZvckZpbGUoZmlsZVBhdGgpO1xuICAgIHRoaXMucmFuZ2VzID0gcmFuZ2VzLnJhbmdlcztcbiAgICBsZXQgZGF0ZSA9IGF3YWl0IEdpdERhdGEuZ2V0Rmlyc3RDb21taXREYXRlRm9yUmVwbyhmaWxlUGF0aCk7XG4gICAgdGhpcy5maXJzdENvbW1pdERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBHdXR0ZXJWaWV3O1xuIl19