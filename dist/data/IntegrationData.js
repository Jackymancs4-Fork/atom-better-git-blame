'use babel';
import StepsizeHelper from '../stepsize/StepsizeHelper';
import * as GitData from './GitData';
import db from './database';
import _ from 'lodash';
import GitHelper from '../git/GitHelper';
let pendingRequests = {};
export async function getIntegrationDataForFile(filePath) {
    const repoPath = await GitData.getRepoRootPath(filePath);
    const metadata = await GitData.getRepoMetadata(repoPath);
    const blame = await GitData.getBlameForFile(filePath);
    if (!pendingRequests[repoPath]) {
        pendingRequests[repoPath] = StepsizeHelper.fetchIntegrationData(metadata, GitHelper.getHashesFromBlame(blame.lines)).then(response => {
            return processIntegrationData(response);
        });
    }
    const response = await pendingRequests[repoPath];
    delete pendingRequests[repoPath];
    return response;
}
async function processIntegrationData(data) {
    const pullRequests = data.pullRequests;
    const jiraIssues = data.relatedJiraIssues;
    const githubIssues = data.relatedGitHubIssues;
    db
        .get('githubIssues')
        .merge(_.toArray(githubIssues))
        .uniqBy('number')
        .write();
    db
        .get('jiraIssues')
        .merge(_.toArray(jiraIssues))
        .uniqBy('key')
        .write();
    pullRequestsCommitsPivot(pullRequests);
    for (const i in pullRequests) {
        const pullRequest = pullRequests[i];
        if (db
            .get('pullRequests')
            .find({ number: pullRequest.number })
            .value()) {
            continue;
        }
        let toWrite = pullRequest;
        toWrite.commitCount = toWrite.commits.length;
        delete toWrite.commits;
        db
            .get('pullRequests')
            .push(toWrite)
            .write();
    }
    return db.get('pullRequests').value();
}
function pullRequestsCommitsPivot(pullRequests) {
    const pivot = _.reduce(pullRequests, (acc, pullRequest, key) => {
        acc[key] = _.map(pullRequest.commits, 'commitHash');
        return acc;
    }, {});
    db
        .get('pullRequestsCommitsPivot')
        .merge(pivot)
        .uniq()
        .write();
    return db.get('pullRequestsCommitsPivot').value();
}
export async function getPullRequestsForCommit(filePath, commitHash) {
    if (pendingRequests[filePath]) {
        await pendingRequests[filePath];
    }
    const results = db
        .get('pullRequestsCommitsPivot')
        .reduce((acc, hashes, prNumber) => {
        if (hashes.includes(commitHash)) {
            acc.push(prNumber);
        }
        return acc;
    }, [])
        .value();
    return results.map(number => {
        return db
            .get('pullRequests')
            .find({ number: parseInt(number) })
            .value();
    });
}
export async function getIssue(filePath, issueKey) {
    if (pendingRequests[filePath]) {
        await pendingRequests[filePath];
    }
    issueKey = issueKey.toString();
    // Assume its a Jira issue if its got a hyphen
    if (issueKey.includes('-')) {
        return db
            .get('jiraIssues')
            .find({ key: issueKey })
            .value();
    }
    return db
        .get('githubIssues')
        .find({ number: parseInt(issueKey) })
        .value();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZWdyYXRpb25EYXRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2RhdGEvSW50ZWdyYXRpb25EYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQztBQUVaLE9BQU8sY0FBYyxNQUFNLDRCQUE0QixDQUFDO0FBQ3hELE9BQU8sS0FBSyxPQUFPLE1BQU0sV0FBVyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM1QixPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDdkIsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFFekMsSUFBSSxlQUFlLEdBQUcsRUFBRSxDQUFDO0FBRXpCLE1BQU0sQ0FBQyxLQUFLLG9DQUFvQyxRQUFnQjtJQUM5RCxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDekQsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFPLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sS0FBSyxHQUFHLE1BQU0sT0FBTyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0RCxFQUFFLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsZUFBZSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxvQkFBb0IsQ0FDN0QsUUFBUSxFQUNSLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQzFDLENBQUMsSUFBSSxDQUFDLFFBQVE7WUFDYixNQUFNLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxRQUFRLEdBQUcsTUFBTSxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakQsT0FBTyxlQUFlLENBQUMsUUFBUSxDQUFD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QUMsQ0FBQztRQUNyQixDQUFDO1FBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUNiLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDTCxLQUFLLEVBQUUsQ0FBQztJQUNYLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU07UUFDdkIsTUFBTSxDQUFDLEVBQUU7YUFDTixHQUFHLENBQUMsY0FBYyxDQUFDO2FBQ25CLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQzthQUNsQyxLQUFLLEVBQUUsQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELE1BQU0sQ0FBQyxLQUFLLG1CQUFtQixRQUFRLEVBQUUsUUFBUTtJQUMvQyxFQUFFLENBQUMsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRCxRQUFRLEdBQUcsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBRS9CLDhDQUE4QztJQUM5QyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsRUFBRTthQUNOLEdBQUcsQ0FBQyxZQUFZLENBQUM7YUFDakIsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxDQUFDO2FBQ3ZCLEtBQUssRUFBRSxDQUFDO0lBQ2IsQ0FBQztJQUVELE1BQU0sQ0FBQyxFQUFFO1NBQ04sR0FBRyxDQUFDLGNBQWMsQ0FBQztTQUNuQixJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7U0FDcEMsS0FBSyxFQUFFLENBQUM7QUFDYixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5cbmltcG9ydCBTdGVwc2l6ZUhlbHBlciBmcm9tICcuLi9zdGVwc2l6ZS9TdGVwc2l6ZUhlbHBlcic7XG5pbXBvcnQgKiBhcyBHaXREYXRhIGZyb20gJy4vR2l0RGF0YSc7XG5pbXBvcnQgZGIgZnJvbSAnLi9kYXRhYmFzZSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEdpdEhlbHBlciBmcm9tICcuLi9naXQvR2l0SGVscGVyJztcblxubGV0IHBlbmRpbmdSZXF1ZXN0cyA9IHt9O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0SW50ZWdyYXRpb25EYXRhRm9yRmlsZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHJlcG9QYXRoID0gYXdhaXQgR2l0RGF0YS5nZXRSZXBvUm9vdFBhdGgoZmlsZVBhdGgpO1xuICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IEdpdERhdGEuZ2V0UmVwb01ldGFkYXRhKHJlcG9QYXRoKTtcbiAgY29uc3QgYmxhbWUgPSBhd2FpdCBHaXREYXRhLmdldEJsYW1lRm9yRmlsZShmaWxlUGF0aCk7XG4gIGlmICghcGVuZGluZ1JlcXVlc3RzW3JlcG9QYXRoXSkge1xuICAgIHBlbmRpbmdSZXF1ZXN0c1tyZXBvUGF0aF0gPSBTdGVwc2l6ZUhlbHBlci5mZXRjaEludGVncmF0aW9uRGF0YShcbiAgICAgIG1ldGFkYXRhLFxuICAgICAgR2l0SGVscGVyLmdldEhhc2hlc0Zyb21CbGFtZShibGFtZS5saW5lcylcbiAgICApLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgcmV0dXJuIHByb2Nlc3NJbnRlZ3JhdGlvbkRhdGEocmVzcG9uc2UpO1xuICAgIH0pO1xuICB9XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcGVuZGluZ1JlcXVlc3RzW3JlcG9QYXRoXTtcbiAgZGVsZXRlIHBlbmRpbmdSZXF1ZXN0c1tyZXBvUGF0aF07XG4gIHJldHVybiByZXNwb25zZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0ludGVncmF0aW9uRGF0YShkYXRhKSB7XG4gIGNvbnN0IHB1bGxSZXF1ZXN0cyA9IGRhdGEucHVsbFJlcXVlc3RzO1xuICBjb25zdCBqaXJhSXNzdWVzID0gZGF0YS5yZWxhdGVkSmlyYUlzc3VlcztcbiAgY29uc3QgZ2l0aHViSXNzdWVzID0gZGF0YS5yZWxhdGVkR2l0SHViSXNzdWVzO1xuICBkYlxuICAgIC5nZXQoJ2dpdGh1Yklzc3VlcycpXG4gICAgLm1lcmdlKF8udG9BcnJheShnaXRodWJJc3N1ZXMpKVxuICAgIC51bmlxQnkoJ251bWJlcicpXG4gICAgLndyaXRlKCk7XG4gIGRiXG4gICAgLmdldCgnamlyYUlzc3VlcycpXG4gICAgLm1lcmdlKF8udG9BcnJheShqaXJhSXNzdWVzKSlcbiAgICAudW5pcUJ5KCdrZXknKVxuICAgIC53cml0ZSgpO1xuICBwdWxsUmVxdWVzdHNDb21taXRzUGl2b3QocHVsbFJlcXVlc3RzKTtcbiAgZm9yIChjb25zdCBpIGluIHB1bGxSZXF1ZXN0cykge1xuICAgIGNvbnN0IHB1bGxSZXF1ZXN0ID0gcHVsbFJlcXVlc3RzW2ldO1xuICAgIGlmIChcbiAgICAgIGRiXG4gICAgICAgIC5nZXQoJ3B1bGxSZXF1ZXN0cycpXG4gICAgICAgIC5maW5kKHsgbnVtYmVyOiBwdWxsUmVxdWVzdC5udW1iZXIgfSlcbiAgICAgICAgLnZhbHVlKClcbiAgICApIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBsZXQgdG9Xcml0ZSA9IHB1bGxSZXF1ZXN0O1xuICAgIHRvV3JpdGUuY29tbWl0Q291bnQgPSB0b1dyaXRlLmNvbW1pdHMubGVuZ3RoO1xuICAgIGRlbGV0ZSB0b1dyaXRlLmNvbW1pdHM7XG4gICAgZGJcbiAgICAgIC5nZXQoJ3B1bGxSZXF1ZXN0cycpXG4gICAgICAucHVzaCh0b1dyaXRlKVxuICAgICAgLndyaXRlKCk7XG4gIH1cbiAgcmV0dXJuIGRiLmdldCgncHVsbFJlcXVlc3RzJykudmFsdWUoKTtcbn1cblxuZnVuY3Rpb24gcHVsbFJlcXVlc3RzQ29tbWl0c1Bpdm90KHB1bGxSZXF1ZXN0cykge1xuICBjb25zdCBwaXZvdCA9IF8ucmVkdWNlKFxuICAgIHB1bGxSZXF1ZXN0cyxcbiAgICAoYWNjOiBBcnJheTx7IG51bWJlcjogbnVtYmVyOyBoYXNoZXM6IHN0cmluZ1tdIH0+LCBwdWxsUmVxdWVzdCwga2V5KSA9PiB7XG4gICAgICBhY2Nba2V5XSA9IF8ubWFwKHB1bGxSZXF1ZXN0LmNvbW1pdHMsICdjb21taXRIYXNoJyk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sXG4gICAge31cbiAgKTtcbiAgZGJcbiAgICAuZ2V0KCdwdWxsUmVxdWVzdHNDb21taXRzUGl2b3QnKVxuICAgIC5tZXJnZShwaXZvdClcbiAgICAudW5pcSgpXG4gICAgLndyaXRlKCk7XG4gIHJldHVybiBkYi5nZXQoJ3B1bGxSZXF1ZXN0c0NvbW1pdHNQaXZvdCcpLnZhbHVlKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQdWxsUmVxdWVzdHNGb3JDb21taXQoZmlsZVBhdGgsIGNvbW1pdEhhc2gpIHtcbiAgaWYgKHBlbmRpbmdSZXF1ZXN0c1tmaWxlUGF0aF0pIHtcbiAgICBhd2FpdCBwZW5kaW5nUmVxdWVzdHNbZmlsZVBhdGhdO1xuICB9XG4gIGNvbnN0IHJlc3VsdHMgPSBkYlxuICAgIC5nZXQoJ3B1bGxSZXF1ZXN0c0NvbW1pdHNQaXZvdCcpXG4gICAgLnJlZHVjZSgoYWNjLCBoYXNoZXMsIHByTnVtYmVyKSA9PiB7XG4gICAgICBpZiAoaGFzaGVzLmluY2x1ZGVzKGNvbW1pdEhhc2gpKSB7XG4gICAgICAgIGFjYy5wdXNoKHByTnVtYmVyKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwgW10pXG4gICAgLnZhbHVlKCk7XG4gIHJldHVybiByZXN1bHRzLm1hcChudW1iZXIgPT4ge1xuICAgIHJldHVybiBkYlxuICAgICAgLmdldCgncHVsbFJlcXVlc3RzJylcbiAgICAgIC5maW5kKHsgbnVtYmVyOiBwYXJzZUludChudW1iZXIpIH0pXG4gICAgICAudmFsdWUoKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRJc3N1ZShmaWxlUGF0aCwgaXNzdWVLZXkpIHtcbiAgaWYgKHBlbmRpbmdSZXF1ZXN0c1tmaWxlUGF0aF0pIHtcbiAgICBhd2FpdCBwZW5kaW5nUmVxdWVzdHNbZmlsZVBhdGhdO1xuICB9XG5cbiAgaXNzdWVLZXkgPSBpc3N1ZUtleS50b1N0cmluZygpO1xuXG4gIC8vIEFzc3VtZSBpdHMgYSBKaXJhIGlzc3VlIGlmIGl0cyBnb3QgYSBoeXBoZW5cbiAgaWYgKGlzc3VlS2V5LmluY2x1ZGVzKCctJykpIHtcbiAgICByZXR1cm4gZGJcbiAgICAgIC5nZXQoJ2ppcmFJc3N1ZXMnKVxuICAgICAgLmZpbmQoeyBrZXk6IGlzc3VlS2V5IH0pXG4gICAgICAudmFsdWUoKTtcbiAgfVxuXG4gIHJldHVybiBkYlxuICAgIC5nZXQoJ2dpdGh1Yklzc3VlcycpXG4gICAgLmZpbmQoeyBudW1iZXI6IHBhcnNlSW50KGlzc3VlS2V5KSB9KVxuICAgIC52YWx1ZSgpO1xufVxuIl19