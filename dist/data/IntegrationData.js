'use babel';
import StepsizeHelper from '../stepsize/StepsizeHelper';
import * as GitData from './GitData';
import db from './database';
import _ from 'lodash';
import GitHelper from '../git/GitHelper';
let pendingRequests = {};
export async function getIntegrationDataForFile(filePath) {
    const repoPath = await GitData.getRepoRootPath(filePath);
    const metadata = await GitData.getRepoMetadata(repoPath);
    const blame = await GitData.getBlameForFile(filePath);
    if (!pendingRequests[repoPath]) {
        pendingRequests[repoPath] = StepsizeHelper.fetchIntegrationData(metadata, GitHelper.getHashesFromBlame(blame.lines)).then(response => {
            return processIntegrationData(response);
        });
    }
    const response = await pendingRequests[repoPath];
    delete pendingRequests[repoPath];
    return response;
}
async function processIntegrationData(data) {
    const pullRequests = data.pullRequests;
    const jiraIssues = data.relatedJiraIssues;
    const githubIssues = data.relatedGitHubIssues;
    db
        .get('githubIssues')
        .merge(_.toArray(githubIssues))
        .uniqBy('number')
        .write();
    db
        .get('jiraIssues')
        .merge(_.toArray(jiraIssues))
        .uniqBy('key')
        .write();
    pullRequestsCommitsPivot(pullRequests);
    for (const i in pullRequests) {
        const pullRequest = pullRequests[i];
        if (db
            .get('pullRequests')
            .find({ number: pullRequest.number })
            .value()) {
            continue;
        }
        let toWrite = pullRequest;
        toWrite.commitCount = toWrite.commits.length;
        toWrite.status = StepsizeHelper.getStatusObject(pullRequest);
        for (const i in pullRequest.commits) {
            const commit = pullRequest.commits[i];
            GitData.updateCommit(commit.commitHash, {
                status: commit.status,
            });
        }
        //delete toWrite.commits;
        db
            .get('pullRequests')
            .push(toWrite)
            .write();
    }
    return db.get('pullRequests').value();
}
function pullRequestsCommitsPivot(pullRequests) {
    const pivot = _.reduce(pullRequests, (acc, pullRequest, key) => {
        acc[key] = _.map(pullRequest.commits, 'commitHash');
        return acc;
    }, {});
    db
        .get('pullRequestsCommitsPivot')
        .merge(pivot)
        .uniq()
        .write();
    return db.get('pullRequestsCommitsPivot').value();
}
export async function getPullRequestsForCommit(filePath, commitHash) {
    if (pendingRequests[filePath]) {
        await pendingRequests[filePath];
    }
    const results = db
        .get('pullRequestsCommitsPivot')
        .reduce((acc, hashes, prNumber) => {
        if (hashes.includes(commitHash)) {
            acc.push(prNumber);
        }
        return acc;
    }, [])
        .value();
    return results.map(number => {
        return db
            .get('pullRequests')
            .find({ number: parseInt(number) })
            .value();
    });
}
export async function getCommitsForPullRequest(filePath, pullRequestNumber) {
    if (pendingRequests[filePath]) {
        await pendingRequests[filePath];
    }
    return db
        .get('pullRequestsCommitsPivot')
        .get(pullRequestNumber)
        .value();
}
export async function getIssue(filePath, issueKey) {
    if (pendingRequests[filePath]) {
        await pendingRequests[filePath];
    }
    issueKey = issueKey.toString();
    // Assume its a Jira issue if its got a hyphen
    if (issueKey.includes('-')) {
        return db
            .get('jiraIssues')
            .find({ key: issueKey })
            .value();
    }
    return db
        .get('githubIssues')
        .find({ number: parseInt(issueKey) })
        .value();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZWdyYXRpb25EYXRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2RhdGEvSW50ZWdyYXRpb25EYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQztBQUVaLE9BQU8sY0FBYyxNQUFNLDRCQUE0QixDQUFDO0FBQ3hELE9BQU8sS0FBSyxPQUFPLE1BQU0sV0FBVyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM1QixPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDdkIsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFFekMsSUFBSSxlQUFlLEdBQUcsRUFBRSxDQUFDO0FBRXpCLE1BQU0sQ0FBQyxLQUFLLG9DQUFvQyxRQUFnQjtJQUM5RCxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDekQsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFPLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sS0FBSyxHQUFHLE1BQU0sT0FBTyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0RCxFQUFFLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsZUFBZSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxvQkFBb0IsQ0FDN0QsUUFBUSxFQUNSLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQzFDLENBQUMsSUFBSSxDQUFDLFFBQVE7WUFDYixNQUFNLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxRQUFRLEdBQUcsTUFBTSxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakQsT0FBTyxlQUFlLENBQUMsUUFBUSxDQUFD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LENBQUM7UUFDOUIsTUFBTSxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7SUFFL0IsOENBQThDO0lBQzlDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxFQUFFO2FBQ04sR0FBRyxDQUFDLFlBQVksQ0FBQzthQUNqQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLENBQUM7YUFDdkIsS0FBSyxFQUFFLENBQUM7SUFDYixDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQUU7U0FDTixHQUFHLENBQUMsY0FBYyxDQUFDO1NBQ25CLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztTQUNwQyxLQUFLLEVBQUUsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IFN0ZXBzaXplSGVscGVyIGZyb20gJy4uL3N0ZXBzaXplL1N0ZXBzaXplSGVscGVyJztcbmltcG9ydCAqIGFzIEdpdERhdGEgZnJvbSAnLi9HaXREYXRhJztcbmltcG9ydCBkYiBmcm9tICcuL2RhdGFiYXNlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgR2l0SGVscGVyIGZyb20gJy4uL2dpdC9HaXRIZWxwZXInO1xuXG5sZXQgcGVuZGluZ1JlcXVlc3RzID0ge307XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRJbnRlZ3JhdGlvbkRhdGFGb3JGaWxlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgcmVwb1BhdGggPSBhd2FpdCBHaXREYXRhLmdldFJlcG9Sb290UGF0aChmaWxlUGF0aCk7XG4gIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgR2l0RGF0YS5nZXRSZXBvTWV0YWRhdGEocmVwb1BhdGgpO1xuICBjb25zdCBibGFtZSA9IGF3YWl0IEdpdERhdGEuZ2V0QmxhbWVGb3JGaWxlKGZpbGVQYXRoKTtcbiAgaWYgKCFwZW5kaW5nUmVxdWVzdHNbcmVwb1BhdGhdKSB7XG4gICAgcGVuZGluZ1JlcXVlc3RzW3JlcG9QYXRoXSA9IFN0ZXBzaXplSGVscGVyLmZldGNoSW50ZWdyYXRpb25EYXRhKFxuICAgICAgbWV0YWRhdGEsXG4gICAgICBHaXRIZWxwZXIuZ2V0SGFzaGVzRnJvbUJsYW1lKGJsYW1lLmxpbmVzKVxuICAgICkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICByZXR1cm4gcHJvY2Vzc0ludGVncmF0aW9uRGF0YShyZXNwb25zZSk7XG4gICAgfSk7XG4gIH1cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBwZW5kaW5nUmVxdWVzdHNbcmVwb1BhdGhdO1xuICBkZWxldGUgcGVuZGluZ1JlcXVlc3RzW3JlcG9QYXRoXTtcbiAgcmV0dXJuIHJlc3BvbnNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzSW50ZWdyYXRpb25EYXRhKGRhdGEpIHtcbiAgY29uc3QgcHVsbFJlcXVlc3RzID0gZGF0YS5wdWxsUmVxdWVzdHM7XG4gIGNvbnN0IGppcmFJc3N1ZXMgPSBkYXRhLnJlbGF0ZWRKaXJhSXNzdWVzO1xuICBjb25zdCBnaXRodWJJc3N1ZXMgPSBkYXRhLnJlbGF0ZWRHaXRIdWJJc3N1ZXM7XG4gIGRiXG4gICAgLmdldCgnZ2l0aHViSXNzdWVzJylcbiAgICAubWVyZ2UoXy50b0FycmF5KGdpdGh1Yklzc3VlcykpXG4gICAgLnVuaXFCeSgnbnVtYmVyJylcbiAgICAud3JpdGUoKTtcbiAgZGJcbiAgICAuZ2V0KCdqaXJhSXNzdWVzJylcbiAgICAubWVyZ2UoXy50b0FycmF5KGppcmFJc3N1ZXMpKVxuICAgIC51bmlxQnkoJ2tleScpXG4gICAgLndyaXRlKCk7XG4gIHB1bGxSZXF1ZXN0c0NvbW1pdHNQaXZvdChwdWxsUmVxdWVzdHMpO1xuICBmb3IgKGNvbnN0IGkgaW4gcHVsbFJlcXVlc3RzKSB7XG4gICAgY29uc3QgcHVsbFJlcXVlc3QgPSBwdWxsUmVxdWVzdHNbaV07XG4gICAgaWYgKFxuICAgICAgZGJcbiAgICAgICAgLmdldCgncHVsbFJlcXVlc3RzJylcbiAgICAgICAgLmZpbmQoeyBudW1iZXI6IHB1bGxSZXF1ZXN0Lm51bWJlciB9KVxuICAgICAgICAudmFsdWUoKVxuICAgICkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGxldCB0b1dyaXRlID0gcHVsbFJlcXVlc3Q7XG4gICAgdG9Xcml0ZS5jb21taXRDb3VudCA9IHRvV3JpdGUuY29tbWl0cy5sZW5ndGg7XG4gICAgdG9Xcml0ZS5zdGF0dXMgPSBTdGVwc2l6ZUhlbHBlci5nZXRTdGF0dXNPYmplY3QocHVsbFJlcXVlc3QpO1xuICAgIGZvciAoY29uc3QgaSBpbiBwdWxsUmVxdWVzdC5jb21taXRzKSB7XG4gICAgICBjb25zdCBjb21taXQgPSBwdWxsUmVxdWVzdC5jb21taXRzW2ldO1xuICAgICAgR2l0RGF0YS51cGRhdGVDb21taXQoY29tbWl0LmNvbW1pdEhhc2gsIHtcbiAgICAgICAgc3RhdHVzOiBjb21taXQuc3RhdHVzLFxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vZGVsZXRlIHRvV3JpdGUuY29tbWl0cztcbiAgICBkYlxuICAgICAgLmdldCgncHVsbFJlcXVlc3RzJylcbiAgICAgIC5wdXNoKHRvV3JpdGUpXG4gICAgICAud3JpdGUoKTtcbiAgfVxuICByZXR1cm4gZGIuZ2V0KCdwdWxsUmVxdWVzdHMnKS52YWx1ZSgpO1xufVxuXG5mdW5jdGlvbiBwdWxsUmVxdWVzdHNDb21taXRzUGl2b3QocHVsbFJlcXVlc3RzKSB7XG4gIGNvbnN0IHBpdm90ID0gXy5yZWR1Y2UoXG4gICAgcHVsbFJlcXVlc3RzLFxuICAgIChhY2M6IEFycmF5PHsgbnVtYmVyOiBudW1iZXI7IGhhc2hlczogc3RyaW5nW10gfT4sIHB1bGxSZXF1ZXN0LCBrZXkpID0+IHtcbiAgICAgIGFjY1trZXldID0gXy5tYXAocHVsbFJlcXVlc3QuY29tbWl0cywgJ2NvbW1pdEhhc2gnKTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSxcbiAgICB7fVxuICApO1xuICBkYlxuICAgIC5nZXQoJ3B1bGxSZXF1ZXN0c0NvbW1pdHNQaXZvdCcpXG4gICAgLm1lcmdlKHBpdm90KVxuICAgIC51bmlxKClcbiAgICAud3JpdGUoKTtcbiAgcmV0dXJuIGRiLmdldCgncHVsbFJlcXVlc3RzQ29tbWl0c1Bpdm90JykudmFsdWUoKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFB1bGxSZXF1ZXN0c0ZvckNvbW1pdChmaWxlUGF0aCwgY29tbWl0SGFzaCkge1xuICBpZiAocGVuZGluZ1JlcXVlc3RzW2ZpbGVQYXRoXSkge1xuICAgIGF3YWl0IHBlbmRpbmdSZXF1ZXN0c1tmaWxlUGF0aF07XG4gIH1cbiAgY29uc3QgcmVzdWx0cyA9IGRiXG4gICAgLmdldCgncHVsbFJlcXVlc3RzQ29tbWl0c1Bpdm90JylcbiAgICAucmVkdWNlKChhY2MsIGhhc2hlcywgcHJOdW1iZXIpID0+IHtcbiAgICAgIGlmIChoYXNoZXMuaW5jbHVkZXMoY29tbWl0SGFzaCkpIHtcbiAgICAgICAgYWNjLnB1c2gocHJOdW1iZXIpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCBbXSlcbiAgICAudmFsdWUoKTtcbiAgcmV0dXJuIHJlc3VsdHMubWFwKG51bWJlciA9PiB7XG4gICAgcmV0dXJuIGRiXG4gICAgICAuZ2V0KCdwdWxsUmVxdWVzdHMnKVxuICAgICAgLmZpbmQoeyBudW1iZXI6IHBhcnNlSW50KG51bWJlcikgfSlcbiAgICAgIC52YWx1ZSgpO1xuICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbW1pdHNGb3JQdWxsUmVxdWVzdChmaWxlUGF0aCwgcHVsbFJlcXVlc3ROdW1iZXIpIHtcbiAgaWYgKHBlbmRpbmdSZXF1ZXN0c1tmaWxlUGF0aF0pIHtcbiAgICBhd2FpdCBwZW5kaW5nUmVxdWVzdHNbZmlsZVBhdGhdO1xuICB9XG4gIHJldHVybiBkYlxuICAgIC5nZXQoJ3B1bGxSZXF1ZXN0c0NvbW1pdHNQaXZvdCcpXG4gICAgLmdldChwdWxsUmVxdWVzdE51bWJlcilcbiAgICAudmFsdWUoKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldElzc3VlKGZpbGVQYXRoLCBpc3N1ZUtleSkge1xuICBpZiAocGVuZGluZ1JlcXVlc3RzW2ZpbGVQYXRoXSkge1xuICAgIGF3YWl0IHBlbmRpbmdSZXF1ZXN0c1tmaWxlUGF0aF07XG4gIH1cblxuICBpc3N1ZUtleSA9IGlzc3VlS2V5LnRvU3RyaW5nKCk7XG5cbiAgLy8gQXNzdW1lIGl0cyBhIEppcmEgaXNzdWUgaWYgaXRzIGdvdCBhIGh5cGhlblxuICBpZiAoaXNzdWVLZXkuaW5jbHVkZXMoJy0nKSkge1xuICAgIHJldHVybiBkYlxuICAgICAgLmdldCgnamlyYUlzc3VlcycpXG4gICAgICAuZmluZCh7IGtleTogaXNzdWVLZXkgfSlcbiAgICAgIC52YWx1ZSgpO1xuICB9XG5cbiAgcmV0dXJuIGRiXG4gICAgLmdldCgnZ2l0aHViSXNzdWVzJylcbiAgICAuZmluZCh7IG51bWJlcjogcGFyc2VJbnQoaXNzdWVLZXkpIH0pXG4gICAgLnZhbHVlKCk7XG59XG4iXX0=