'use babel';
import GitHelper from '../git/GitHelper';
import gitBlame from '../git/blame';
import gitShow from '../git/show';
import gitRemotes from '../git/remotes';
import getFirstCommitDate from '../git/firstCommitDate';
import findRepoRoot from '../git/findRepoRoot';
import GutterRange from '../interface/GutterRange';
import db from './database';
import _ from 'lodash';
const blamePromises = {};
export async function getBlameForFile(filePath) {
    let existing = db
        .get('blames')
        .find({ path: filePath })
        .value();
    if (existing && Date.now() - existing.fetchedAt < 1000) {
        return existing;
    }
    if (!blamePromises[filePath]) {
        blamePromises[filePath] = gitBlame(filePath);
    }
    const blame = await blamePromises[filePath];
    db
        .get('blames')
        .remove({ path: filePath })
        .write();
    db
        .get('blames')
        .push({
        path: filePath,
        lines: blame.replace(/\s+$/, '').split('\n'),
        fetchedAt: new Date(),
    })
        .write();
    delete blamePromises[filePath];
    return db
        .get('blames')
        .find({ path: filePath })
        .value();
}
export async function getCommitsForFile(filePath) {
    let existing = db
        .get('fileCommits')
        .find({ path: filePath })
        .value();
    if (existing && Date.now() - existing.fetchedAt < 1000) {
        return existing;
    }
    const blame = await getBlameForFile(filePath);
    const repoPath = await getRepoRootPath(filePath);
    const commits = blame.lines.reduce((acc, line) => {
        const parsed = GitHelper.parseBlameLine(line);
        parsed.repoPath = repoPath;
        if (acc[parsed.commitHash]) {
            return acc;
        }
        acc[parsed.commitHash] = parsed;
        return acc;
    }, {});
    db
        .get('fileCommits')
        .remove({ path: filePath })
        .write();
    db
        .get('fileCommits')
        .push({
        path: filePath,
        commits,
        fetchedAt: new Date(),
    })
        .write();
    loadCommits(repoPath, _.filter(_.map(commits, 'commitHash'), hash => hash.substr(0, 6) !== '000000'));
    return db
        .get('fileCommits')
        .find({ path: filePath })
        .value();
}
export async function getGutterRangesForFile(filePath) {
    const blame = await getBlameForFile(filePath);
    let lineRanges = [];
    for (let i = 0; i < blame.lines.length; i++) {
        const line = blame.lines[i];
        const commitHash = line.split(' ')[0];
        // Build array of ranges
        if (lineRanges.length == 0) {
            // No ranges exist
            lineRanges.push(new GutterRange(i, commitHash));
        }
        else {
            const currentRange = lineRanges[lineRanges.length - 1]; // Get last range
            if (currentRange.identifier === commitHash) {
                currentRange.incrementRange();
            }
            else {
                // Add new range
                lineRanges.push(new GutterRange(i, commitHash));
            }
        }
    }
    return {
        path: filePath,
        ranges: _.groupBy(lineRanges, 'identifier'),
        fetchedAt: new Date(),
    };
}
const firstDatePromises = {};
export async function getFirstCommitDateForRepo(filePath) {
    return getRepoRootPath(filePath).then(async (repoPath) => {
        const cached = db
            .get('startDates')
            .get(repoPath)
            .value();
        if (cached) {
            return cached;
        }
        if (!firstDatePromises[filePath]) {
            firstDatePromises[filePath] = getFirstCommitDate(repoPath);
        }
        const date = await firstDatePromises[filePath];
        db
            .get('startDates')
            .set(filePath, date)
            .write();
        delete firstDatePromises[filePath];
        return date;
    });
}
let loadPromise;
async function loadCommits(filePath, hashes) {
    if (loadPromise) {
        await loadPromise;
    }
    loadPromise = gitShow(filePath, hashes);
    const commits = await loadPromise;
    for (const i in commits) {
        const commit = commits[i];
        if (commit) {
            const toWrite = {
                commitHash: commit.hash,
                ...commit,
                fetchedAt: new Date(),
            };
            db
                .get('commitMessages')
                .set(commit.hash, toWrite)
                .write();
        }
    }
}
const commitPromises = {};
export async function getCommit(filePath, hash) {
    if (loadPromise) {
        await loadPromise;
    }
    let existing = db
        .get('commitMessages')
        .get(hash)
        .value();
    if (existing) {
        return existing;
    }
    if (!commitPromises[hash]) {
        commitPromises[hash] = gitShow(filePath, [hash]);
    }
    const commit = await commitPromises[hash];
    const toWrite = {
        commitHash: hash,
        ...commit[0],
        fetchedAt: new Date(),
    };
    db
        .get('commitMessages')
        .set(commit.hash, toWrite)
        .write();
    delete commitPromises[hash];
    return toWrite;
}
export function updateCommit(hash, data) {
    db
        .get('commitMessages')
        .get(hash)
        .assign(data)
        .write();
    return db
        .get('commitMessages')
        .get(hash)
        .value();
}
export async function getRepoRootPath(filePath) {
    let cached = db.get(`rootPaths.${filePath}`).value();
    if (cached) {
        return cached;
    }
    let rootPath = findRepoRoot(filePath);
    db
        .get('rootPaths')
        .set(filePath, rootPath)
        .write();
    return rootPath;
}
const metadataPromises = {};
export async function getRepoMetadata(repoPath) {
    let cached = db
        .get('repoMetadata')
        .find({
        rootPath: repoPath,
    })
        .value();
    if (cached) {
        return cached;
    }
    if (!metadataPromises[repoPath]) {
        metadataPromises[repoPath] = gitRemotes(repoPath);
    }
    const remotes = await metadataPromises[repoPath];
    const metadata = GitHelper.extractRepoMetadataFromRemotes(remotes);
    const toWrite = {
        rootPath: repoPath,
        ...metadata,
        fetchedAt: new Date(),
    };
    db
        .get('repoMetadata')
        .push(toWrite)
        .write();
    delete metadataPromises[repoPath];
    return toWrite;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2l0RGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9kYXRhL0dpdERhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDO0FBRVosT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxRQUFRLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUNsQyxPQUFPLFVBQVUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLGtCQUFrQixNQUFNLHdCQUF3QixDQUFDO0FBQ3hELE9BQU8sWUFBWSxNQUFNLHFCQUFxQixDQUFDO0FBQy9DLE9BQU8sV0FBVyxNQUFNLDBCQUEwQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM1QixPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFFdkIsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLE1BQU0sQ0FBQyxLQUFLLDBCQUEwQixRQUFnQjtJQUNwRCxJQUFJLFFBQVEsR0FBRyxFQUFFO1NBQ2QsR0FBRyxDQUFDLFFBQVEsQ0FBQztTQUNiLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQztTQUN4QixLQUFLLEVBQUUsQ0FBQztJQUNYLEVBQUUsQ0FBQyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QixhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFDRCxNQUFNLEtBQUssR0FBRyxNQUFNLGFBQWEsQ0FBQyxRQUFRLENB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O1NBQ3ZCLEtBQUssRUFBRSxDQUFDO0lBQ1gsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBRUQsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDNUIsTUFBTSxDQUFDLEtBQUssMEJBQTBCLFFBQWdCO0lBQ3BELElBQUksTUFBTSxHQUFHLEVBQUU7U0FDWixHQUFHLENBQUMsY0FBYyxDQUFDO1NBQ25CLElBQUksQ0FBQztRQUNKLFFBQVEsRUFBRSxRQUFRO0tBQ25CLENBQUM7U0FDRCxLQUFLLEVBQUUsQ0FBQztJQUNYLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDWCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUNELE1BQU0sT0FBTyxHQUFHLE1BQU0sZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakQsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLDhCQUE4QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ25FLE1BQU0sT0FBTyxHQUFHO1FBQ2QsUUFBUSxFQUFFLFFBQVE7UUFDbEIsR0FBRyxRQUFRO1FBQ1gsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO0tBQ3RCLENBQUM7SUFDRixFQUFFO1NBQ0MsR0FBRyxDQUFDLGNBQWMsQ0FBQztTQUNuQixJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ2IsS0FBSyxFQUFFLENBQUM7SUFDWCxPQUFPLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sQ0FBQyxPQUFPLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgR2l0SGVscGVyIGZyb20gJy4uL2dpdC9HaXRIZWxwZXInO1xuaW1wb3J0IGdpdEJsYW1lIGZyb20gJy4uL2dpdC9ibGFtZSc7XG5pbXBvcnQgZ2l0U2hvdyBmcm9tICcuLi9naXQvc2hvdyc7XG5pbXBvcnQgZ2l0UmVtb3RlcyBmcm9tICcuLi9naXQvcmVtb3Rlcyc7XG5pbXBvcnQgZ2V0Rmlyc3RDb21taXREYXRlIGZyb20gJy4uL2dpdC9maXJzdENvbW1pdERhdGUnO1xuaW1wb3J0IGZpbmRSZXBvUm9vdCBmcm9tICcuLi9naXQvZmluZFJlcG9Sb290JztcbmltcG9ydCBHdXR0ZXJSYW5nZSBmcm9tICcuLi9pbnRlcmZhY2UvR3V0dGVyUmFuZ2UnO1xuaW1wb3J0IGRiIGZyb20gJy4vZGF0YWJhc2UnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgYmxhbWVQcm9taXNlcyA9IHt9O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEJsYW1lRm9yRmlsZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGxldCBleGlzdGluZyA9IGRiXG4gICAgLmdldCgnYmxhbWVzJylcbiAgICAuZmluZCh7IHBhdGg6IGZpbGVQYXRoIH0pXG4gICAgLnZhbHVlKCk7XG4gIGlmIChleGlzdGluZyAmJiBEYXRlLm5vdygpIC0gZXhpc3RpbmcuZmV0Y2hlZEF0IDwgMTAwMCkge1xuICAgIHJldHVybiBleGlzdGluZztcbiAgfVxuICBpZiAoIWJsYW1lUHJvbWlzZXNbZmlsZVBhdGhdKSB7XG4gICAgYmxhbWVQcm9taXNlc1tmaWxlUGF0aF0gPSBnaXRCbGFtZShmaWxlUGF0aCk7XG4gIH1cbiAgY29uc3QgYmxhbWUgPSBhd2FpdCBibGFtZVByb21pc2VzW2ZpbGVQYXRoXTtcbiAgZGJcbiAgICAuZ2V0KCdibGFtZXMnKVxuICAgIC5yZW1vdmUoeyBwYXRoOiBmaWxlUGF0aCB9KVxuICAgIC53cml0ZSgpO1xuICBkYlxuICAgIC5nZXQoJ2JsYW1lcycpXG4gICAgLnB1c2goe1xuICAgICAgcGF0aDogZmlsZVBhdGgsXG4gICAgICBsaW5lczogYmxhbWUucmVwbGFjZSgvXFxzKyQvLCAnJykuc3BsaXQoJ1xcbicpLFxuICAgICAgZmV0Y2hlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIH0pXG4gICAgLndyaXRlKCk7XG4gIGRlbGV0ZSBibGFtZVByb21pc2VzW2ZpbGVQYXRoXTtcbiAgcmV0dXJuIGRiXG4gICAgLmdldCgnYmxhbWVzJylcbiAgICAuZmluZCh7IHBhdGg6IGZpbGVQYXRoIH0pXG4gICAgLnZhbHVlKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDb21taXRzRm9yRmlsZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGxldCBleGlzdGluZyA9IGRiXG4gICAgLmdldCgnZmlsZUNvbW1pdHMnKVxuICAgIC5maW5kKHsgcGF0aDogZmlsZVBhdGggfSlcbiAgICAudmFsdWUoKTtcbiAgaWYgKGV4aXN0aW5nICYmIERhdGUubm93KCkgLSBleGlzdGluZy5mZXRjaGVkQXQgPCAxMDAwKSB7XG4gICAgcmV0dXJuIGV4aXN0aW5nO1xuICB9XG4gIGNvbnN0IGJsYW1lID0gYXdhaXQgZ2V0QmxhbWVGb3JGaWxlKGZpbGVQYXRoKTtcbiAgY29uc3QgcmVwb1BhdGggPSBhd2FpdCBnZXRSZXBvUm9vdFBhdGgoZmlsZVBhdGgpO1xuICBjb25zdCBjb21taXRzID0gYmxhbWUubGluZXMucmVkdWNlKChhY2MsIGxpbmUpID0+IHtcbiAgICBjb25zdCBwYXJzZWQgPSBHaXRIZWxwZXIucGFyc2VCbGFtZUxpbmUobGluZSk7XG4gICAgcGFyc2VkLnJlcG9QYXRoID0gcmVwb1BhdGg7XG4gICAgaWYgKGFjY1twYXJzZWQuY29tbWl0SGFzaF0pIHtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfVxuICAgIGFjY1twYXJzZWQuY29tbWl0SGFzaF0gPSBwYXJzZWQ7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuICBkYlxuICAgIC5nZXQoJ2ZpbGVDb21taXRzJylcbiAgICAucmVtb3ZlKHsgcGF0aDogZmlsZVBhdGggfSlcbiAgICAud3JpdGUoKTtcbiAgZGJcbiAgICAuZ2V0KCdmaWxlQ29tbWl0cycpXG4gICAgLnB1c2goe1xuICAgICAgcGF0aDogZmlsZVBhdGgsXG4gICAgICBjb21taXRzLFxuICAgICAgZmV0Y2hlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIH0pXG4gICAgLndyaXRlKCk7XG4gIGxvYWRDb21taXRzKFxuICAgIHJlcG9QYXRoLFxuICAgIF8uZmlsdGVyKFxuICAgICAgXy5tYXAoY29tbWl0cywgJ2NvbW1pdEhhc2gnKSxcbiAgICAgIGhhc2ggPT4gaGFzaC5zdWJzdHIoMCwgNikgIT09ICcwMDAwMDAnXG4gICAgKVxuICApO1xuICByZXR1cm4gZGJcbiAgICAuZ2V0KCdmaWxlQ29tbWl0cycpXG4gICAgLmZpbmQoeyBwYXRoOiBmaWxlUGF0aCB9KVxuICAgIC52YWx1ZSgpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0R3V0dGVyUmFuZ2VzRm9yRmlsZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IGJsYW1lID0gYXdhaXQgZ2V0QmxhbWVGb3JGaWxlKGZpbGVQYXRoKTtcbiAgbGV0IGxpbmVSYW5nZXMgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBibGFtZS5saW5lcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGxpbmUgPSBibGFtZS5saW5lc1tpXTtcbiAgICBjb25zdCBjb21taXRIYXNoID0gbGluZS5zcGxpdCgnICcpWzBdO1xuICAgIC8vIEJ1aWxkIGFycmF5IG9mIHJhbmdlc1xuICAgIGlmIChsaW5lUmFuZ2VzLmxlbmd0aCA9PSAwKSB7XG4gICAgICAvLyBObyByYW5nZXMgZXhpc3RcbiAgICAgIGxpbmVSYW5nZXMucHVzaChuZXcgR3V0dGVyUmFuZ2UoaSwgY29tbWl0SGFzaCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjdXJyZW50UmFuZ2U6IEd1dHRlclJhbmdlID0gbGluZVJhbmdlc1tsaW5lUmFuZ2VzLmxlbmd0aCAtIDFdOyAvLyBHZXQgbGFzdCByYW5nZVxuICAgICAgaWYgKGN1cnJlbnRSYW5nZS5pZGVudGlmaWVyID09PSBjb21taXRIYXNoKSB7XG4gICAgICAgIGN1cnJlbnRSYW5nZS5pbmNyZW1lbnRSYW5nZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gQWRkIG5ldyByYW5nZVxuICAgICAgICBsaW5lUmFuZ2VzLnB1c2gobmV3IEd1dHRlclJhbmdlKGksIGNvbW1pdEhhc2gpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBwYXRoOiBmaWxlUGF0aCxcbiAgICByYW5nZXM6IF8uZ3JvdXBCeShsaW5lUmFuZ2VzLCAnaWRlbnRpZmllcicpLFxuICAgIGZldGNoZWRBdDogbmV3IERhdGUoKSxcbiAgfTtcbn1cblxuY29uc3QgZmlyc3REYXRlUHJvbWlzZXMgPSB7fTtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGaXJzdENvbW1pdERhdGVGb3JSZXBvKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGdldFJlcG9Sb290UGF0aChmaWxlUGF0aCkudGhlbihhc3luYyByZXBvUGF0aCA9PiB7XG4gICAgY29uc3QgY2FjaGVkID0gZGJcbiAgICAgIC5nZXQoJ3N0YXJ0RGF0ZXMnKVxuICAgICAgLmdldChyZXBvUGF0aClcbiAgICAgIC52YWx1ZSgpO1xuICAgIGlmIChjYWNoZWQpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuICAgIGlmICghZmlyc3REYXRlUHJvbWlzZXNbZmlsZVBhdGhdKSB7XG4gICAgICBmaXJzdERhdGVQcm9taXNlc1tmaWxlUGF0aF0gPSBnZXRGaXJzdENvbW1pdERhdGUocmVwb1BhdGgpO1xuICAgIH1cbiAgICBjb25zdCBkYXRlID0gYXdhaXQgZmlyc3REYXRlUHJvbWlzZXNbZmlsZVBhdGhdO1xuICAgIGRiXG4gICAgICAuZ2V0KCdzdGFydERhdGVzJylcbiAgICAgIC5zZXQoZmlsZVBhdGgsIGRhdGUpXG4gICAgICAud3JpdGUoKTtcbiAgICBkZWxldGUgZmlyc3REYXRlUHJvbWlzZXNbZmlsZVBhdGhdO1xuICAgIHJldHVybiBkYXRlO1xuICB9KTtcbn1cblxubGV0IGxvYWRQcm9taXNlOiBQcm9taXNlO1xuYXN5bmMgZnVuY3Rpb24gbG9hZENvbW1pdHMoZmlsZVBhdGgsIGhhc2hlcykge1xuICBpZiAobG9hZFByb21pc2UpIHtcbiAgICBhd2FpdCBsb2FkUHJvbWlzZTtcbiAgfVxuICBsb2FkUHJvbWlzZSA9IGdpdFNob3coZmlsZVBhdGgsIGhhc2hlcyk7XG4gIGNvbnN0IGNvbW1pdHMgPSBhd2FpdCBsb2FkUHJvbWlzZTtcbiAgZm9yIChjb25zdCBpIGluIGNvbW1pdHMpIHtcbiAgICBjb25zdCBjb21taXQgPSBjb21taXRzW2ldO1xuICAgIGlmIChjb21taXQpIHtcbiAgICAgIGNvbnN0IHRvV3JpdGUgPSB7XG4gICAgICAgIGNvbW1pdEhhc2g6IGNvbW1pdC5oYXNoLFxuICAgICAgICAuLi5jb21taXQsXG4gICAgICAgIGZldGNoZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH07XG4gICAgICBkYlxuICAgICAgICAuZ2V0KCdjb21taXRNZXNzYWdlcycpXG4gICAgICAgIC5zZXQoY29tbWl0Lmhhc2gsIHRvV3JpdGUpXG4gICAgICAgIC53cml0ZSgpO1xuICAgIH1cbiAgfVxufVxuXG5jb25zdCBjb21taXRQcm9taXNlcyA9IHt9O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbW1pdChmaWxlUGF0aCwgaGFzaCkge1xuICBpZiAobG9hZFByb21pc2UpIHtcbiAgICBhd2FpdCBsb2FkUHJvbWlzZTtcbiAgfVxuICBsZXQgZXhpc3RpbmcgPSBkYlxuICAgIC5nZXQoJ2NvbW1pdE1lc3NhZ2VzJylcbiAgICAuZ2V0KGhhc2gpXG4gICAgLnZhbHVlKCk7XG4gIGlmIChleGlzdGluZykge1xuICAgIHJldHVybiBleGlzdGluZztcbiAgfVxuICBpZiAoIWNvbW1pdFByb21pc2VzW2hhc2hdKSB7XG4gICAgY29tbWl0UHJvbWlzZXNbaGFzaF0gPSBnaXRTaG93KGZpbGVQYXRoLCBbaGFzaF0pO1xuICB9XG4gIGNvbnN0IGNvbW1pdCA9IGF3YWl0IGNvbW1pdFByb21pc2VzW2hhc2hdO1xuICBjb25zdCB0b1dyaXRlID0ge1xuICAgIGNvbW1pdEhhc2g6IGhhc2gsXG4gICAgLi4uY29tbWl0WzBdLFxuICAgIGZldGNoZWRBdDogbmV3IERhdGUoKSxcbiAgfTtcbiAgZGJcbiAgICAuZ2V0KCdjb21taXRNZXNzYWdlcycpXG4gICAgLnNldChjb21taXQuaGFzaCwgdG9Xcml0ZSlcbiAgICAud3JpdGUoKTtcbiAgZGVsZXRlIGNvbW1pdFByb21pc2VzW2hhc2hdO1xuICByZXR1cm4gdG9Xcml0ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUNvbW1pdChoYXNoLCBkYXRhKSB7XG4gIGRiXG4gICAgLmdldCgnY29tbWl0TWVzc2FnZXMnKVxuICAgIC5nZXQoaGFzaClcbiAgICAuYXNzaWduKGRhdGEpXG4gICAgLndyaXRlKCk7XG4gIHJldHVybiBkYlxuICAgIC5nZXQoJ2NvbW1pdE1lc3NhZ2VzJylcbiAgICAuZ2V0KGhhc2gpXG4gICAgLnZhbHVlKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRSZXBvUm9vdFBhdGgoZmlsZVBhdGg6IHN0cmluZykge1xuICBsZXQgY2FjaGVkID0gZGIuZ2V0KGByb290UGF0aHMuJHtmaWxlUGF0aH1gKS52YWx1ZSgpO1xuICBpZiAoY2FjaGVkKSB7XG4gICAgcmV0dXJuIGNhY2hlZDtcbiAgfVxuICBsZXQgcm9vdFBhdGggPSBmaW5kUmVwb1Jvb3QoZmlsZVBhdGgpO1xuICBkYlxuICAgIC5nZXQoJ3Jvb3RQYXRocycpXG4gICAgLnNldChmaWxlUGF0aCwgcm9vdFBhdGgpXG4gICAgLndyaXRlKCk7XG4gIHJldHVybiByb290UGF0aDtcbn1cblxuY29uc3QgbWV0YWRhdGFQcm9taXNlcyA9IHt9O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJlcG9NZXRhZGF0YShyZXBvUGF0aDogc3RyaW5nKSB7XG4gIGxldCBjYWNoZWQgPSBkYlxuICAgIC5nZXQoJ3JlcG9NZXRhZGF0YScpXG4gICAgLmZpbmQoe1xuICAgICAgcm9vdFBhdGg6IHJlcG9QYXRoLFxuICAgIH0pXG4gICAgLnZhbHVlKCk7XG4gIGlmIChjYWNoZWQpIHtcbiAgICByZXR1cm4gY2FjaGVkO1xuICB9XG4gIGlmICghbWV0YWRhdGFQcm9taXNlc1tyZXBvUGF0aF0pIHtcbiAgICBtZXRhZGF0YVByb21pc2VzW3JlcG9QYXRoXSA9IGdpdFJlbW90ZXMocmVwb1BhdGgpO1xuICB9XG4gIGNvbnN0IHJlbW90ZXMgPSBhd2FpdCBtZXRhZGF0YVByb21pc2VzW3JlcG9QYXRoXTtcbiAgY29uc3QgbWV0YWRhdGEgPSBHaXRIZWxwZXIuZXh0cmFjdFJlcG9NZXRhZGF0YUZyb21SZW1vdGVzKHJlbW90ZXMpO1xuICBjb25zdCB0b1dyaXRlID0ge1xuICAgIHJvb3RQYXRoOiByZXBvUGF0aCxcbiAgICAuLi5tZXRhZGF0YSxcbiAgICBmZXRjaGVkQXQ6IG5ldyBEYXRlKCksXG4gIH07XG4gIGRiXG4gICAgLmdldCgncmVwb01ldGFkYXRhJylcbiAgICAucHVzaCh0b1dyaXRlKVxuICAgIC53cml0ZSgpO1xuICBkZWxldGUgbWV0YWRhdGFQcm9taXNlc1tyZXBvUGF0aF07XG4gIHJldHVybiB0b1dyaXRlO1xufVxuIl19