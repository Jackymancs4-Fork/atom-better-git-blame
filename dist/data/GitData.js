'use babel';
import GitHelper from '../git/GitHelper';
import gitBlame from '../git/blame';
import gitShow from '../git/show';
import gitRemotes from '../git/remotes';
import getFirstCommitDate from '../git/firstCommitDate';
import findRepoRoot from '../git/findRepoRoot';
import GutterRange from '../interface/GutterRange';
import db from './database';
import _ from 'lodash';
const blamePromises = {};
export async function getBlameForFile(filePath) {
    let existing = db
        .get('blames')
        .find({ path: filePath })
        .value();
    if (existing && Date.now() - existing.fetchedAt < 1000) {
        return existing;
    }
    if (!blamePromises[filePath]) {
        blamePromises[filePath] = gitBlame(filePath);
    }
    const blame = await blamePromises[filePath];
    db
        .get('blames')
        .remove({ path: filePath })
        .write();
    db
        .get('blames')
        .push({
        path: filePath,
        lines: blame.replace(/\s+$/, '').split('\n'),
        fetchedAt: new Date(),
    })
        .write();
    delete blamePromises[filePath];
    return db
        .get('blames')
        .find({ path: filePath })
        .value();
}
export async function getCommitsForFile(filePath) {
    let existing = db
        .get('fileCommits')
        .find({ path: filePath })
        .value();
    if (existing && Date.now() - existing.fetchedAt < 1000) {
        return existing;
    }
    const blame = await getBlameForFile(filePath);
    const repoPath = await getRepoRootPath(filePath);
    const commits = blame.lines.reduce((acc, line) => {
        const parsed = GitHelper.parseBlameLine(line);
        parsed.repoPath = repoPath;
        if (acc[parsed.commitHash]) {
            return acc;
        }
        acc[parsed.commitHash] = parsed;
        return acc;
    }, {});
    db
        .get('fileCommits')
        .remove({ path: filePath })
        .write();
    db
        .get('fileCommits')
        .push({
        path: filePath,
        commits,
        fetchedAt: new Date(),
    })
        .write();
    loadCommits(repoPath, _.filter(_.map(commits, 'commitHash'), hash => hash.substr(0, 6) !== '000000'));
    return db
        .get('fileCommits')
        .find({ path: filePath })
        .value();
}
export async function getGutterRangesForFile(filePath) {
    const blame = await getBlameForFile(filePath);
    let lineRanges = [];
    for (let i = 0; i < blame.lines.length; i++) {
        const line = blame.lines[i];
        const commitHash = line.split(' ')[0];
        // Build array of ranges
        if (lineRanges.length == 0) {
            // No ranges exist
            lineRanges.push(new GutterRange(i, commitHash));
        }
        else {
            const currentRange = lineRanges[lineRanges.length - 1]; // Get last range
            if (currentRange.identifier === commitHash) {
                currentRange.incrementRange();
            }
            else {
                // Add new range
                lineRanges.push(new GutterRange(i, commitHash));
            }
        }
    }
    return {
        path: filePath,
        ranges: _.groupBy(lineRanges, 'identifier'),
        fetchedAt: new Date(),
    };
}
const firstDatePromises = {};
export async function getFirstCommitDateForRepo(filePath) {
    return getRepoRootPath(filePath).then(async (repoPath) => {
        const cached = db
            .get('startDates')
            .get(repoPath)
            .value();
        if (cached) {
            return cached;
        }
        if (!firstDatePromises[filePath]) {
            firstDatePromises[filePath] = getFirstCommitDate(repoPath);
        }
        const date = await firstDatePromises[filePath];
        db
            .get('startDates')
            .set(filePath, date)
            .write();
        delete firstDatePromises[filePath];
        return date;
    });
}
async function loadCommits(filePath, hashes) {
    const commits = await gitShow(filePath, hashes);
    commits.map(commit => {
        const toWrite = {
            commitHash: commit.hash,
            ...commit,
            fetchedAt: new Date(),
        };
        db
            .get('commitMessages')
            .push(toWrite)
            .write();
    });
}
const commitPromises = {};
export async function getCommit(filePath, hash) {
    let existing = db
        .get('commitMessages')
        .find({ commitHash: hash })
        .value();
    if (existing) {
        return existing;
    }
    if (!commitPromises[filePath]) {
        commitPromises[filePath] = gitShow(filePath, [hash]);
    }
    const commit = await commitPromises[filePath];
    const toWrite = {
        commitHash: hash,
        ...commit[0],
        fetchedAt: new Date(),
    };
    db
        .get('commitMessages')
        .push(toWrite)
        .write();
    delete commitPromises[filePath];
    return toWrite;
}
export async function getRepoRootPath(filePath) {
    let cached = db.get(`rootPaths.${filePath}`).value();
    if (cached) {
        return cached;
    }
    let rootPath = findRepoRoot(filePath);
    db
        .get('rootPaths')
        .set(filePath, rootPath)
        .write();
    return rootPath;
}
const metadataPromises = {};
export async function getRepoMetadata(repoPath) {
    let cached = db
        .get('repoMetadata')
        .find({
        rootPath: repoPath,
    })
        .value();
    if (cached) {
        return cached;
    }
    if (!metadataPromises[repoPath]) {
        metadataPromises[repoPath] = gitRemotes(repoPath);
    }
    const remotes = await metadataPromises[repoPath];
    const metadata = GitHelper.extractRepoMetadataFromRemotes(remotes);
    const toWrite = {
        rootPath: repoPath,
        ...metadata,
        fetchedAt: new Date(),
    };
    db
        .get('repoMetadata')
        .push(toWrite)
        .write();
    delete metadataPromises[repoPath];
    return toWrite;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2l0RGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9kYXRhL0dpdERhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDO0FBRVosT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxRQUFRLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUNsQyxPQUFPLFVBQVUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLGtCQUFrQixNQUFNLHdCQUF3QixDQUFDO0FBQ3hELE9BQU8sWUFBWSxNQUFNLHFCQUFxQixDQUFDO0FBQy9DLE9BQU8sV0FBVyxNQUFNLDBCQUEwQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM1QixPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFFdkIsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLE1BQU0sQ0FBQyxLQUFLLDBCQUEwQixRQUFnQjtJQUNwRCxJQUFJLFFBQVEsR0FBRyxFQUFFO1NBQ2QsR0FBRyxDQUFDLFFBQVEsQ0FBQztTQUNiLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQztTQUN4QixLQUFLLEVBQUUsQ0FBQztJQUNYLEVBQUUsQ0FBQyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QixhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFDRCxNQUFNLEtBQUssR0FBRyxNQUFNLGFBQWEsQ0FBQyxRQUFRLENB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LEdBQUc7UUFDZCxRQUFRLEVBQUUsUUFBUTtRQUNsQixHQUFHLFFBQVE7UUFDWCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7S0FDdEIsQ0FBQztJQUNGLEVBQUU7U0FDQyxHQUFHLENBQUMsY0FBYyxDQUFDO1NBQ25CLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDYixLQUFLLEVBQUUsQ0FBQztJQUNYLE9BQU8sZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbEMsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5cbmltcG9ydCBHaXRIZWxwZXIgZnJvbSAnLi4vZ2l0L0dpdEhlbHBlcic7XG5pbXBvcnQgZ2l0QmxhbWUgZnJvbSAnLi4vZ2l0L2JsYW1lJztcbmltcG9ydCBnaXRTaG93IGZyb20gJy4uL2dpdC9zaG93JztcbmltcG9ydCBnaXRSZW1vdGVzIGZyb20gJy4uL2dpdC9yZW1vdGVzJztcbmltcG9ydCBnZXRGaXJzdENvbW1pdERhdGUgZnJvbSAnLi4vZ2l0L2ZpcnN0Q29tbWl0RGF0ZSc7XG5pbXBvcnQgZmluZFJlcG9Sb290IGZyb20gJy4uL2dpdC9maW5kUmVwb1Jvb3QnO1xuaW1wb3J0IEd1dHRlclJhbmdlIGZyb20gJy4uL2ludGVyZmFjZS9HdXR0ZXJSYW5nZSc7XG5pbXBvcnQgZGIgZnJvbSAnLi9kYXRhYmFzZSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5jb25zdCBibGFtZVByb21pc2VzID0ge307XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QmxhbWVGb3JGaWxlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgbGV0IGV4aXN0aW5nID0gZGJcbiAgICAuZ2V0KCdibGFtZXMnKVxuICAgIC5maW5kKHsgcGF0aDogZmlsZVBhdGggfSlcbiAgICAudmFsdWUoKTtcbiAgaWYgKGV4aXN0aW5nICYmIERhdGUubm93KCkgLSBleGlzdGluZy5mZXRjaGVkQXQgPCAxMDAwKSB7XG4gICAgcmV0dXJuIGV4aXN0aW5nO1xuICB9XG4gIGlmICghYmxhbWVQcm9taXNlc1tmaWxlUGF0aF0pIHtcbiAgICBibGFtZVByb21pc2VzW2ZpbGVQYXRoXSA9IGdpdEJsYW1lKGZpbGVQYXRoKTtcbiAgfVxuICBjb25zdCBibGFtZSA9IGF3YWl0IGJsYW1lUHJvbWlzZXNbZmlsZVBhdGhdO1xuICBkYlxuICAgIC5nZXQoJ2JsYW1lcycpXG4gICAgLnJlbW92ZSh7IHBhdGg6IGZpbGVQYXRoIH0pXG4gICAgLndyaXRlKCk7XG4gIGRiXG4gICAgLmdldCgnYmxhbWVzJylcbiAgICAucHVzaCh7XG4gICAgICBwYXRoOiBmaWxlUGF0aCxcbiAgICAgIGxpbmVzOiBibGFtZS5yZXBsYWNlKC9cXHMrJC8sICcnKS5zcGxpdCgnXFxuJyksXG4gICAgICBmZXRjaGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgfSlcbiAgICAud3JpdGUoKTtcbiAgZGVsZXRlIGJsYW1lUHJvbWlzZXNbZmlsZVBhdGhdO1xuICByZXR1cm4gZGJcbiAgICAuZ2V0KCdibGFtZXMnKVxuICAgIC5maW5kKHsgcGF0aDogZmlsZVBhdGggfSlcbiAgICAudmFsdWUoKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbW1pdHNGb3JGaWxlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgbGV0IGV4aXN0aW5nID0gZGJcbiAgICAuZ2V0KCdmaWxlQ29tbWl0cycpXG4gICAgLmZpbmQoeyBwYXRoOiBmaWxlUGF0aCB9KVxuICAgIC52YWx1ZSgpO1xuICBpZiAoZXhpc3RpbmcgJiYgRGF0ZS5ub3coKSAtIGV4aXN0aW5nLmZldGNoZWRBdCA8IDEwMDApIHtcbiAgICByZXR1cm4gZXhpc3Rpbmc7XG4gIH1cbiAgY29uc3QgYmxhbWUgPSBhd2FpdCBnZXRCbGFtZUZvckZpbGUoZmlsZVBhdGgpO1xuICBjb25zdCByZXBvUGF0aCA9IGF3YWl0IGdldFJlcG9Sb290UGF0aChmaWxlUGF0aCk7XG4gIGNvbnN0IGNvbW1pdHMgPSBibGFtZS5saW5lcy5yZWR1Y2UoKGFjYywgbGluZSkgPT4ge1xuICAgIGNvbnN0IHBhcnNlZCA9IEdpdEhlbHBlci5wYXJzZUJsYW1lTGluZShsaW5lKTtcbiAgICBwYXJzZWQucmVwb1BhdGggPSByZXBvUGF0aDtcbiAgICBpZiAoYWNjW3BhcnNlZC5jb21taXRIYXNoXSkge1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9XG4gICAgYWNjW3BhcnNlZC5jb21taXRIYXNoXSA9IHBhcnNlZDtcbiAgICByZXR1cm4gYWNjO1xuICB9LCB7fSk7XG4gIGRiXG4gICAgLmdldCgnZmlsZUNvbW1pdHMnKVxuICAgIC5yZW1vdmUoeyBwYXRoOiBmaWxlUGF0aCB9KVxuICAgIC53cml0ZSgpO1xuICBkYlxuICAgIC5nZXQoJ2ZpbGVDb21taXRzJylcbiAgICAucHVzaCh7XG4gICAgICBwYXRoOiBmaWxlUGF0aCxcbiAgICAgIGNvbW1pdHMsXG4gICAgICBmZXRjaGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgfSlcbiAgICAud3JpdGUoKTtcbiAgbG9hZENvbW1pdHMoXG4gICAgcmVwb1BhdGgsXG4gICAgXy5maWx0ZXIoXG4gICAgICBfLm1hcChjb21taXRzLCAnY29tbWl0SGFzaCcpLFxuICAgICAgaGFzaCA9PiBoYXNoLnN1YnN0cigwLCA2KSAhPT0gJzAwMDAwMCdcbiAgICApXG4gICk7XG4gIHJldHVybiBkYlxuICAgIC5nZXQoJ2ZpbGVDb21taXRzJylcbiAgICAuZmluZCh7IHBhdGg6IGZpbGVQYXRoIH0pXG4gICAgLnZhbHVlKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHdXR0ZXJSYW5nZXNGb3JGaWxlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgYmxhbWUgPSBhd2FpdCBnZXRCbGFtZUZvckZpbGUoZmlsZVBhdGgpO1xuICBsZXQgbGluZVJhbmdlcyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGJsYW1lLmxpbmVzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgbGluZSA9IGJsYW1lLmxpbmVzW2ldO1xuICAgIGNvbnN0IGNvbW1pdEhhc2ggPSBsaW5lLnNwbGl0KCcgJylbMF07XG4gICAgLy8gQnVpbGQgYXJyYXkgb2YgcmFuZ2VzXG4gICAgaWYgKGxpbmVSYW5nZXMubGVuZ3RoID09IDApIHtcbiAgICAgIC8vIE5vIHJhbmdlcyBleGlzdFxuICAgICAgbGluZVJhbmdlcy5wdXNoKG5ldyBHdXR0ZXJSYW5nZShpLCBjb21taXRIYXNoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRSYW5nZTogR3V0dGVyUmFuZ2UgPSBsaW5lUmFuZ2VzW2xpbmVSYW5nZXMubGVuZ3RoIC0gMV07IC8vIEdldCBsYXN0IHJhbmdlXG4gICAgICBpZiAoY3VycmVudFJhbmdlLmlkZW50aWZpZXIgPT09IGNvbW1pdEhhc2gpIHtcbiAgICAgICAgY3VycmVudFJhbmdlLmluY3JlbWVudFJhbmdlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBBZGQgbmV3IHJhbmdlXG4gICAgICAgIGxpbmVSYW5nZXMucHVzaChuZXcgR3V0dGVyUmFuZ2UoaSwgY29tbWl0SGFzaCkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4ge1xuICAgIHBhdGg6IGZpbGVQYXRoLFxuICAgIHJhbmdlczogXy5ncm91cEJ5KGxpbmVSYW5nZXMsICdpZGVudGlmaWVyJyksXG4gICAgZmV0Y2hlZEF0OiBuZXcgRGF0ZSgpLFxuICB9O1xufVxuXG5jb25zdCBmaXJzdERhdGVQcm9taXNlcyA9IHt9O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEZpcnN0Q29tbWl0RGF0ZUZvclJlcG8oZmlsZVBhdGg6IHN0cmluZykge1xuICByZXR1cm4gZ2V0UmVwb1Jvb3RQYXRoKGZpbGVQYXRoKS50aGVuKGFzeW5jIHJlcG9QYXRoID0+IHtcbiAgICBjb25zdCBjYWNoZWQgPSBkYlxuICAgICAgLmdldCgnc3RhcnREYXRlcycpXG4gICAgICAuZ2V0KHJlcG9QYXRoKVxuICAgICAgLnZhbHVlKCk7XG4gICAgaWYgKGNhY2hlZCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG4gICAgaWYgKCFmaXJzdERhdGVQcm9taXNlc1tmaWxlUGF0aF0pIHtcbiAgICAgIGZpcnN0RGF0ZVByb21pc2VzW2ZpbGVQYXRoXSA9IGdldEZpcnN0Q29tbWl0RGF0ZShyZXBvUGF0aCk7XG4gICAgfVxuICAgIGNvbnN0IGRhdGUgPSBhd2FpdCBmaXJzdERhdGVQcm9taXNlc1tmaWxlUGF0aF07XG4gICAgZGJcbiAgICAgIC5nZXQoJ3N0YXJ0RGF0ZXMnKVxuICAgICAgLnNldChmaWxlUGF0aCwgZGF0ZSlcbiAgICAgIC53cml0ZSgpO1xuICAgIGRlbGV0ZSBmaXJzdERhdGVQcm9taXNlc1tmaWxlUGF0aF07XG4gICAgcmV0dXJuIGRhdGU7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkQ29tbWl0cyhmaWxlUGF0aCwgaGFzaGVzKSB7XG4gIGNvbnN0IGNvbW1pdHMgPSBhd2FpdCBnaXRTaG93KGZpbGVQYXRoLCBoYXNoZXMpO1xuICBjb21taXRzLm1hcChjb21taXQgPT4ge1xuICAgIGNvbnN0IHRvV3JpdGUgPSB7XG4gICAgICBjb21taXRIYXNoOiBjb21taXQuaGFzaCxcbiAgICAgIC4uLmNvbW1pdCxcbiAgICAgIGZldGNoZWRBdDogbmV3IERhdGUoKSxcbiAgICB9O1xuICAgIGRiXG4gICAgICAuZ2V0KCdjb21taXRNZXNzYWdlcycpXG4gICAgICAucHVzaCh0b1dyaXRlKVxuICAgICAgLndyaXRlKCk7XG4gIH0pO1xufVxuXG5jb25zdCBjb21taXRQcm9taXNlcyA9IHt9O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbW1pdChmaWxlUGF0aCwgaGFzaCkge1xuICBsZXQgZXhpc3RpbmcgPSBkYlxuICAgIC5nZXQoJ2NvbW1pdE1lc3NhZ2VzJylcbiAgICAuZmluZCh7IGNvbW1pdEhhc2g6IGhhc2ggfSlcbiAgICAudmFsdWUoKTtcbiAgaWYgKGV4aXN0aW5nKSB7XG4gICAgcmV0dXJuIGV4aXN0aW5nO1xuICB9XG4gIGlmICghY29tbWl0UHJvbWlzZXNbZmlsZVBhdGhdKSB7XG4gICAgY29tbWl0UHJvbWlzZXNbZmlsZVBhdGhdID0gZ2l0U2hvdyhmaWxlUGF0aCwgW2hhc2hdKTtcbiAgfVxuICBjb25zdCBjb21taXQgPSBhd2FpdCBjb21taXRQcm9taXNlc1tmaWxlUGF0aF07XG4gIGNvbnN0IHRvV3JpdGUgPSB7XG4gICAgY29tbWl0SGFzaDogaGFzaCxcbiAgICAuLi5jb21taXRbMF0sXG4gICAgZmV0Y2hlZEF0OiBuZXcgRGF0ZSgpLFxuICB9O1xuICBkYlxuICAgIC5nZXQoJ2NvbW1pdE1lc3NhZ2VzJylcbiAgICAucHVzaCh0b1dyaXRlKVxuICAgIC53cml0ZSgpO1xuICBkZWxldGUgY29tbWl0UHJvbWlzZXNbZmlsZVBhdGhdO1xuICByZXR1cm4gdG9Xcml0ZTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJlcG9Sb290UGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGxldCBjYWNoZWQgPSBkYi5nZXQoYHJvb3RQYXRocy4ke2ZpbGVQYXRofWApLnZhbHVlKCk7XG4gIGlmIChjYWNoZWQpIHtcbiAgICByZXR1cm4gY2FjaGVkO1xuICB9XG4gIGxldCByb290UGF0aCA9IGZpbmRSZXBvUm9vdChmaWxlUGF0aCk7XG4gIGRiXG4gICAgLmdldCgncm9vdFBhdGhzJylcbiAgICAuc2V0KGZpbGVQYXRoLCByb290UGF0aClcbiAgICAud3JpdGUoKTtcbiAgcmV0dXJuIHJvb3RQYXRoO1xufVxuXG5jb25zdCBtZXRhZGF0YVByb21pc2VzID0ge307XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmVwb01ldGFkYXRhKHJlcG9QYXRoOiBzdHJpbmcpIHtcbiAgbGV0IGNhY2hlZCA9IGRiXG4gICAgLmdldCgncmVwb01ldGFkYXRhJylcbiAgICAuZmluZCh7XG4gICAgICByb290UGF0aDogcmVwb1BhdGgsXG4gICAgfSlcbiAgICAudmFsdWUoKTtcbiAgaWYgKGNhY2hlZCkge1xuICAgIHJldHVybiBjYWNoZWQ7XG4gIH1cbiAgaWYgKCFtZXRhZGF0YVByb21pc2VzW3JlcG9QYXRoXSkge1xuICAgIG1ldGFkYXRhUHJvbWlzZXNbcmVwb1BhdGhdID0gZ2l0UmVtb3RlcyhyZXBvUGF0aCk7XG4gIH1cbiAgY29uc3QgcmVtb3RlcyA9IGF3YWl0IG1ldGFkYXRhUHJvbWlzZXNbcmVwb1BhdGhdO1xuICBjb25zdCBtZXRhZGF0YSA9IEdpdEhlbHBlci5leHRyYWN0UmVwb01ldGFkYXRhRnJvbVJlbW90ZXMocmVtb3Rlcyk7XG4gIGNvbnN0IHRvV3JpdGUgPSB7XG4gICAgcm9vdFBhdGg6IHJlcG9QYXRoLFxuICAgIC4uLm1ldGFkYXRhLFxuICAgIGZldGNoZWRBdDogbmV3IERhdGUoKSxcbiAgfTtcbiAgZGJcbiAgICAuZ2V0KCdyZXBvTWV0YWRhdGEnKVxuICAgIC5wdXNoKHRvV3JpdGUpXG4gICAgLndyaXRlKCk7XG4gIGRlbGV0ZSBtZXRhZGF0YVByb21pc2VzW3JlcG9QYXRoXTtcbiAgcmV0dXJuIHRvV3JpdGU7XG59XG4iXX0=