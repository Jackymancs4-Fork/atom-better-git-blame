'use babel';
import { createSocket } from 'dgram';
import fs from 'fs';
import StepsizeHelper from './StepsizeHelper';
class StepsizeOutgoing {
    constructor() {
        this.readyTries = 1;
        // sendError - sends error message to Stepsize
        this.sendError = data => {
            let editor = atom.workspace.getActiveTextEditor();
            if (!editor) {
                return;
            }
            let event = {
                source: 'atom',
                action: 'error',
                filename: fs.realpathSync(editor.getPath()),
                selected: JSON.stringify(data),
                plugin_id: this.pluginId,
            };
            this.send(event);
        };
        this.pluginId = 'atom_v0.0.2';
        this.DEBUG = false;
        this.UDP_HOST = '127.0.0.1';
        this.UDP_PORT = 49369;
        this.OUTGOING_SOCK = createSocket('udp4');
        this.layerReady = false;
        this.OUTGOING_SOCK.on('message', (msg) => {
            const parsedMessage = JSON.parse(msg);
            if (parsedMessage.type === 'ready' && parsedMessage.source.name === 'Layer') {
                this.layerReady = true;
                if (this.cachedMessage) {
                    this.send(this.cachedMessage);
                }
                clearInterval(this.readyInterval);
            }
        });
    }
    checkLayerIsReady() {
        if (this.layerReady) {
            return;
        }
        this.sendReady();
        this.readyCheckTimer();
    }
    readyCheckTimer() {
        this.readyRetryTimer = 3 * (Math.pow(this.readyTries / 10, 2) + 1);
        this.readyInterval = setTimeout(() => {
            this.readyTries++;
            this.sendReady();
            this.readyCheckTimer();
        }, this.readyRetryTimer * 1000);
    }
    send(event, callback) {
        if (!this.layerReady && event.type !== 'ready') {
            this.checkLayerIsReady();
            this.cachedMessage = event;
            if (callback) {
                callback();
            }
            return;
        }
        let msg = JSON.stringify(event);
        this.OUTGOING_SOCK.send(msg, 0, msg.length, this.UDP_PORT, this.UDP_HOST, callback);
    }
    sendReady() {
        const event = {
            type: 'ready',
            source: { name: 'BetterGitBlame', version: '0.1.0' },
        };
        this.send(event);
    }
    buildSelectionEvent(editor) {
        const ranges = editor.selections.map(selection => {
            return selection.getBufferRange();
        });
        return this.buildEvent(editor, ranges, 'selection');
    }
    buildEvent(editor, ranges, action, shouldPerformSearch = false) {
        const selectedLineNumbers = StepsizeHelper.rangesToSelectedLineNumbers(ranges);
        return {
            source: 'atom',
            action: action,
            filename: editor.getPath() || null,
            plugin_id: this.pluginId,
            selectedLineNumbers,
            shouldPerformSearch: shouldPerformSearch,
        };
    }
}
export default StepsizeOutgoing;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RlcHNpemVPdXRnb2luZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zdGVwc2l6ZS9TdGVwc2l6ZU91dGdvaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQztBQUVaLE9BQU8sRUFBVSxZQUFZLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDN0MsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFDO0FBRzlDO0lBWUU7UUFKUSxlQUFVLEdBQVcsQ0FBQyxDQUFDO1FBb0UvQiw4Q0FBOEM7UUFDOUMsY0FBUyxHQUFHLElBQUk7WUFDZCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNaLE1BQU0sQ0FBQztZQUNULENBQUM7WUFDRCxJQUFJLEtBQUssR0FBRztnQkFDVixNQUFNLEVBQUUsTUFBTTtnQkFDZCxNQUFNLEVBQUUsT0FBTztnQkFDZixRQUFRLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzNDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztnQkFDOUIsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRO2FBQ3pCLENBQUM7WUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25CLENBQUMsQ0FBQztRQTdFQSxJQUFJLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQztRQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQztRQUM1QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsYUFBYSxHQUFHLFlBQVksQ0FB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QUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxtQkFBbUIsR0FBRyxLQUFLO1FBQzVELE1BQU0sbUJBQW1CLEdBQUcsY0FBYyxDQUFDLDJCQUEyQixDQUNwRSxNQUFNLENBQ1AsQ0FBQztRQUNGLE1BQU0sQ0FBQztZQUNMLE1BQU0sRUFBRSxNQUFNO1lBQ2QsTUFBTSxFQUFFLE1BQU07WUFDZCxRQUFRLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLElBQUk7WUFDbEMsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3hCLG1CQUFtQjtZQUNuQixtQkFBbUIsRUFBRSxtQkFBbUI7U0FDekMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQUVELGVBQWUsZ0JBQWdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IHsgU29ja2V0LCBjcmVhdGVTb2NrZXQgfSBmcm9tICdkZ3JhbSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IFN0ZXBzaXplSGVscGVyIGZyb20gJy4vU3RlcHNpemVIZWxwZXInO1xuaW1wb3J0IFRpbWVyID0gTm9kZUpTLlRpbWVyO1xuXG5jbGFzcyBTdGVwc2l6ZU91dGdvaW5nIHtcbiAgcHJpdmF0ZSBwbHVnaW5JZDtcbiAgcHJpdmF0ZSBERUJVRzogYm9vbGVhbjtcbiAgcHJpdmF0ZSBVRFBfSE9TVDogc3RyaW5nO1xuICBwcml2YXRlIFVEUF9QT1JUOiBudW1iZXI7XG4gIHByaXZhdGUgT1VUR09JTkdfU09DSzogU29ja2V0O1xuICBwcml2YXRlIGxheWVyUmVhZHk6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZHlJbnRlcnZhbDogVGltZXI7XG4gIHByaXZhdGUgcmVhZHlUcmllczogbnVtYmVyID0gMTtcbiAgcHJpdmF0ZSByZWFkeVJldHJ5VGltZXI6IG51bWJlcjtcbiAgcHJpdmF0ZSBjYWNoZWRNZXNzYWdlOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5wbHVnaW5JZCA9ICdhdG9tX3YwLjAuMic7XG4gICAgdGhpcy5ERUJVRyA9IGZhbHNlO1xuICAgIHRoaXMuVURQX0hPU1QgPSAnMTI3LjAuMC4xJztcbiAgICB0aGlzLlVEUF9QT1JUID0gNDkzNjk7XG4gICAgdGhpcy5PVVRHT0lOR19TT0NLID0gY3JlYXRlU29ja2V0KCd1ZHA0Jyk7XG4gICAgdGhpcy5sYXllclJlYWR5ID0gZmFsc2U7XG4gICAgdGhpcy5PVVRHT0lOR19TT0NLLm9uKCdtZXNzYWdlJywgKG1zZykgPT4ge1xuICAgICAgY29uc3QgcGFyc2VkTWVzc2FnZSA9IEpTT04ucGFyc2UobXNnKTtcbiAgICAgIGlmKHBhcnNlZE1lc3NhZ2UudHlwZSA9PT0gJ3JlYWR5JyAmJiBwYXJzZWRNZXNzYWdlLnNvdXJjZS5uYW1lID09PSAnTGF5ZXInKXtcbiAgICAgICAgdGhpcy5sYXllclJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgaWYodGhpcy5jYWNoZWRNZXNzYWdlKXtcbiAgICAgICAgICB0aGlzLnNlbmQodGhpcy5jYWNoZWRNZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgICBjbGVhckludGVydmFsKHRoaXMucmVhZHlJbnRlcnZhbCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrTGF5ZXJJc1JlYWR5KCl7XG4gICAgaWYodGhpcy5sYXllclJlYWR5KXtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zZW5kUmVhZHkoKTtcbiAgICB0aGlzLnJlYWR5Q2hlY2tUaW1lcigpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWFkeUNoZWNrVGltZXIoKSB7XG4gICAgdGhpcy5yZWFkeVJldHJ5VGltZXIgPSAzICogKE1hdGgucG93KHRoaXMucmVhZHlUcmllcyAvIDEwLCAyKSsxKTtcbiAgICB0aGlzLnJlYWR5SW50ZXJ2YWwgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMucmVhZHlUcmllcysrO1xuICAgICAgdGhpcy5zZW5kUmVhZHkoKTtcbiAgICAgIHRoaXMucmVhZHlDaGVja1RpbWVyKCk7XG4gICAgfSwgdGhpcy5yZWFkeVJldHJ5VGltZXIgKiAxMDAwKTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kKGV2ZW50LCBjYWxsYmFjaz8pIHtcbiAgICBpZighdGhpcy5sYXllclJlYWR5ICYmIGV2ZW50LnR5cGUgIT09ICdyZWFkeScpe1xuICAgICAgdGhpcy5jaGVja0xheWVySXNSZWFkeSgpO1xuICAgICAgdGhpcy5jYWNoZWRNZXNzYWdlID0gZXZlbnQ7XG4gICAgICBpZihjYWxsYmFjayl7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBtc2cgPSBKU09OLnN0cmluZ2lmeShldmVudCk7XG4gICAgdGhpcy5PVVRHT0lOR19TT0NLLnNlbmQoXG4gICAgICBtc2csXG4gICAgICAwLFxuICAgICAgbXNnLmxlbmd0aCxcbiAgICAgIHRoaXMuVURQX1BPUlQsXG4gICAgICB0aGlzLlVEUF9IT1NULFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgc2VuZFJlYWR5KCkge1xuICAgIGNvbnN0IGV2ZW50ID0ge1xuICAgICAgdHlwZTogJ3JlYWR5JyxcbiAgICAgIHNvdXJjZTogeyBuYW1lOiAnQmV0dGVyR2l0QmxhbWUnLCB2ZXJzaW9uOiAnMC4xLjAnIH0sXG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZXZlbnQpO1xuICB9XG5cbiAgLy8gc2VuZEVycm9yIC0gc2VuZHMgZXJyb3IgbWVzc2FnZSB0byBTdGVwc2l6ZVxuICBzZW5kRXJyb3IgPSBkYXRhID0+IHtcbiAgICBsZXQgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIGlmICghZWRpdG9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBldmVudCA9IHtcbiAgICAgIHNvdXJjZTogJ2F0b20nLFxuICAgICAgYWN0aW9uOiAnZXJyb3InLFxuICAgICAgZmlsZW5hbWU6IGZzLnJlYWxwYXRoU3luYyhlZGl0b3IuZ2V0UGF0aCgpKSxcbiAgICAgIHNlbGVjdGVkOiBKU09OLnN0cmluZ2lmeShkYXRhKSxcbiAgICAgIHBsdWdpbl9pZDogdGhpcy5wbHVnaW5JZCxcbiAgICB9O1xuICAgIHRoaXMuc2VuZChldmVudCk7XG4gIH07XG5cbiAgYnVpbGRTZWxlY3Rpb25FdmVudChlZGl0b3IpIHtcbiAgICBjb25zdCByYW5nZXMgPSBlZGl0b3Iuc2VsZWN0aW9ucy5tYXAoc2VsZWN0aW9uID0+IHtcbiAgICAgIHJldHVybiBzZWxlY3Rpb24uZ2V0QnVmZmVyUmFuZ2UoKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5idWlsZEV2ZW50KGVkaXRvciwgcmFuZ2VzLCAnc2VsZWN0aW9uJyk7XG4gIH1cblxuICBidWlsZEV2ZW50KGVkaXRvciwgcmFuZ2VzLCBhY3Rpb24sIHNob3VsZFBlcmZvcm1TZWFyY2ggPSBmYWxzZSkge1xuICAgIGNvbnN0IHNlbGVjdGVkTGluZU51bWJlcnMgPSBTdGVwc2l6ZUhlbHBlci5yYW5nZXNUb1NlbGVjdGVkTGluZU51bWJlcnMoXG4gICAgICByYW5nZXNcbiAgICApO1xuICAgIHJldHVybiB7XG4gICAgICBzb3VyY2U6ICdhdG9tJyxcbiAgICAgIGFjdGlvbjogYWN0aW9uLFxuICAgICAgZmlsZW5hbWU6IGVkaXRvci5nZXRQYXRoKCkgfHwgbnVsbCxcbiAgICAgIHBsdWdpbl9pZDogdGhpcy5wbHVnaW5JZCxcbiAgICAgIHNlbGVjdGVkTGluZU51bWJlcnMsXG4gICAgICBzaG91bGRQZXJmb3JtU2VhcmNoOiBzaG91bGRQZXJmb3JtU2VhcmNoLFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU3RlcHNpemVPdXRnb2luZztcbiJdfQ==